# ุฏููู ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน - ูุธุงู ุงูุนูููุงุช

## ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุณุงุนุฏู ุนูู ุงูุชุญูู ูู ุนูู ูุธุงู ุงูุนูููุงุช ุจุดูู ุตุญูุญ.

---

## ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ

1. โ ุงูุณูุฑูุฑุงุช ุชุนูู ุนูู:
   - API: http://localhost:3000
   - Agent Portal: http://localhost:3004
   - Manager Portal: http://localhost:3003

2. โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุญุชูู ุนูู:
   - ููุฏูุจ ูุงุญุฏ ุนูู ุงูุฃูู
   - ูุฏูุฑ ูุญุงูุธุฉ ูุงุญุฏ ุนูู ุงูุฃูู
   - ุจุงูุฌุงุช (Packages)

---

## ุงูุณููุงุฑูู 1: ููุฏูุจ ููุซูู (Auto-Approve)

### ุงูุฎุทูุฉ 1: ุฅุนุฏุงุฏ ุงูููุฏูุจ

**ุงูุทุฑููุฉ:** ูู ููุญุฉ ุชุญูู ุงููุฏูุฑ

1. ุงูุชุญ http://localhost:3003
2. ุณุฌู ุงูุฏุฎูู ููุฏูุฑ ูุญุงูุธุฉ
3. ุงุฐูุจ ุฅูู "ุงูููุฏูุจูู" โ "ุฅุถุงูุฉ ููุฏูุจ ุฌุฏูุฏ"
4. ุงููุฃ ุงูุจูุงูุงุช:
   ```
   ุงูุงุณู ุงูุฃูู: ุฃุญูุฏ
   ุงูุงุณู ุงูุฃุฎูุฑ: ูุญูุฏ
   ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: agent1@test.com
   ุฑูู ุงููุงุชู: 01012345678
   ุงููุญุงูุธุงุช: [ุงุฎุชุฑ ูุญุงูุธุฉ]
   
   โ๏ธ ุงูููู:
   โ ูู ุจุฅูุบุงุก ุชูุนูู "ุชุญุชุงุฌ ุงูุฃูุดุทุฉ ุฅูู ูุฑุงุฌุนุฉุ"
   โ ูุณุจุฉ ุงูุนูููุฉ: 10 (ุฃู 10%)
   ```

### ุงูุฎุทูุฉ 2: ุฅุถุงูุฉ ูุดุงุท ุชุฌุงุฑู

**ุงูุทุฑููุฉ:** ูู ููุญุฉ ุชุญูู ุงูููุฏูุจ

1. ุงูุชุญ http://localhost:3004
2. ุณุฌู ุงูุฏุฎูู ุจู agent1@test.com
3. ุงุฐูุจ ุฅูู "ุงูุฃูุดุทุฉ ุงูุชุฌุงุฑูุฉ" โ "ุฅุถุงูุฉ ูุดุงุท ุฌุฏูุฏ"
4. ุงููุฃ ุงูุจูุงูุงุช:
   ```
   ุงูุงุณู ุจุงูุนุฑุจู: ูุทุนู ุงูุฎูุฑ
   ุงูุชุตููู: ูุทุงุนู
   ุงููุญุงูุธุฉ: [ููุณ ูุญุงูุธุฉ ุงูููุฏูุจ]
   ุฑูู ุงููุงุชู: 0123456789
   
   ุงุฎุชุฑ ุจุงูุฌ: ุงุฎุชุฑ ุฃู ุจุงูุฌ (ูุซูุงู: ุจุงูุฌ ุจุณุนุฑ 1000 ุฌููู)
   ```

### ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู ุงููุชุงุฆุฌ

#### 3.1 ูู ููุญุฉ ุชุญูู ุงูููุฏูุจ

1. ุนุฏ ุฅูู Dashboard
2. ุชุญูู ูู:
   ```
   โ ุฅุฌูุงูู ุงูุฃูุดุทุฉ: 1
   โ ุงูุฃูุดุทุฉ ุงููุนุชูุฏุฉ: 1
   โ ุงูุนูููุงุช ุงููุนุชูุฏุฉ: 100 ุฌููู (ุฅุฐุง ุงูุจุงูุฌ 1000 ูุงูุนูููุฉ 10%)
   ```

#### 3.2 ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

ุงูุชุญ SQL client ููู ุจุงูุงุณุชุนูุงู:

```sql
-- 1. ุงูุชุญูู ูู ุญุงูุฉ ุงููุดุงุท
SELECT id, name_ar, status, agent_id
FROM businesses
WHERE name_ar = 'ูุทุนู ุงูุฎูุฑ';
-- ุงููุชููุน: status = 'APPROVED'

-- 2. ุงูุชุญูู ูู ุงูุนูููุฉ
SELECT 
  ac.id,
  ac.subscription_amount,
  ac.commission_rate,
  ac.commission_amount,
  ac.status,
  ac.approved_at
FROM agent_commissions ac
JOIN businesses b ON ac.business_id = b.id
WHERE b.name_ar = 'ูุทุนู ุงูุฎูุฑ';
-- ุงููุชููุน:
-- subscription_amount = 1000
-- commission_rate = 10
-- commission_amount = 100
-- status = 'APPROVED'
-- approved_at = [ุชุงุฑูุฎ ูููุช]

-- 3. ุงูุชุญูู ูู ุฅุฌูุงูู ุนูููุงุช ุงูููุฏูุจ
SELECT 
  user_id,
  total_commissions,
  total_businesses
FROM agent_profiles
WHERE user_id = (SELECT id FROM users WHERE email = 'agent1@test.com');
-- ุงููุชููุน:
-- total_commissions = 100
-- total_businesses = 1
```

---

## ุงูุณููุงุฑูู 2: ููุฏูุจ ุนุงุฏู (ูุญุชุงุฌ ููุงููุฉ)

### ุงูุฎุทูุฉ 1: ุฅุนุฏุงุฏ ุงูููุฏูุจ

**ุงูุทุฑููุฉ:** ูู ููุญุฉ ุชุญูู ุงููุฏูุฑ

1. ุงูุชุญ http://localhost:3003
2. ุงุฐูุจ ุฅูู "ุงูููุฏูุจูู" โ "ุฅุถุงูุฉ ููุฏูุจ ุฌุฏูุฏ"
3. ุงููุฃ ุงูุจูุงูุงุช:
   ```
   ุงูุงุณู ุงูุฃูู: ุฎุงูุฏ
   ุงูุงุณู ุงูุฃุฎูุฑ: ุฃุญูุฏ
   ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: agent2@test.com
   
   โ๏ธ ุงูููู:
   โ ูู ุจุชูุนูู "ุชุญุชุงุฌ ุงูุฃูุดุทุฉ ุฅูู ูุฑุงุฌุนุฉุ"
   โ ูุณุจุฉ ุงูุนูููุฉ: 15 (ุฃู 15%)
   ```

### ุงูุฎุทูุฉ 2: ุฅุถุงูุฉ ูุดุงุท ุชุฌุงุฑู

**ุงูุทุฑููุฉ:** ูู ููุญุฉ ุชุญูู ุงูููุฏูุจ

1. ุงูุชุญ http://localhost:3004
2. ุณุฌู ุงูุฏุฎูู ุจู agent2@test.com
3. ุงุฐูุจ ุฅูู "ุงูุฃูุดุทุฉ ุงูุชุฌุงุฑูุฉ" โ "ุฅุถุงูุฉ ูุดุงุท ุฌุฏูุฏ"
4. ุงููุฃ ุงูุจูุงูุงุช:
   ```
   ุงูุงุณู ุจุงูุนุฑุจู: ุตูุฏููุฉ ุงูุดูุงุก
   ุงุฎุชุฑ ุจุงูุฌ ุจุณุนุฑ 500 ุฌููู
   ```

### ุงูุฎุทูุฉ 3: ุงูุชุญูู ูุจู ุงูููุงููุฉ

#### 3.1 ูู ููุญุฉ ุชุญูู ุงูููุฏูุจ

```
โ ุฅุฌูุงูู ุงูุฃูุดุทุฉ: 1
โ ุงูุฃูุดุทุฉ ุงููุนููุฉ: 1
โ ุงูุฃูุดุทุฉ ุงููุนุชูุฏุฉ: 0
โ ุงูุนูููุงุช ุงููุนุชูุฏุฉ: 0 (ูู ูุชู ุงูููุงููุฉ ุจุนุฏ)
```

#### 3.2 ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```sql
-- ุงูุชุญูู ูู ุญุงูุฉ ุงููุดุงุท
SELECT status FROM businesses WHERE name_ar = 'ุตูุฏููุฉ ุงูุดูุงุก';
-- ุงููุชููุน: status = 'PENDING'

-- ุงูุชุญูู ูู ุงูุนูููุงุช
SELECT COUNT(*) FROM agent_commissions 
WHERE business_id = (SELECT id FROM businesses WHERE name_ar = 'ุตูุฏููุฉ ุงูุดูุงุก');
-- ุงููุชููุน: 0 (ูุง ุชูุฌุฏ ุนูููุงุช ุจุนุฏ)
```

### ุงูุฎุทูุฉ 4: ููุงููุฉ ุงููุฏูุฑ

**ุงูุทุฑููุฉ:** ูู ููุญุฉ ุชุญูู ุงููุฏูุฑ

1. ุงูุชุญ http://localhost:3003
2. ุงุฐูุจ ุฅูู "ุงูุฃูุดุทุฉ ุงููุนููุฉ"
3. ุงุจุญุซ ุนู "ุตูุฏููุฉ ุงูุดูุงุก"
4. ุงุถุบุท ุนูู "ููุงููุฉ" โ

### ุงูุฎุทูุฉ 5: ุงูุชุญูู ุจุนุฏ ุงูููุงููุฉ

#### 5.1 ูู ููุญุฉ ุชุญูู ุงูููุฏูุจ

```
โ ุฅุฌูุงูู ุงูุฃูุดุทุฉ: 1
โ ุงูุฃูุดุทุฉ ุงููุนููุฉ: 0
โ ุงูุฃูุดุทุฉ ุงููุนุชูุฏุฉ: 1
โ ุงูุนูููุงุช ุงููุนุชูุฏุฉ: 75 ุฌููู (500 * 15% = 75)
```

#### 5.2 ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```sql
-- ุงูุชุญูู ูู ุญุงูุฉ ุงููุดุงุท
SELECT status FROM businesses WHERE name_ar = 'ุตูุฏููุฉ ุงูุดูุงุก';
-- ุงููุชููุน: status = 'APPROVED'

-- ุงูุชุญูู ูู ุงูุนูููุฉ
SELECT 
  subscription_amount,
  commission_rate,
  commission_amount,
  status
FROM agent_commissions 
WHERE business_id = (SELECT id FROM businesses WHERE name_ar = 'ุตูุฏููุฉ ุงูุดูุงุก');
-- ุงููุชููุน:
-- subscription_amount = 500
-- commission_rate = 15
-- commission_amount = 75
-- status = 'APPROVED'

-- ุงูุชุญูู ูู ุฅุฌูุงูู ุนูููุงุช ุงูููุฏูุจ
SELECT total_commissions, total_businesses
FROM agent_profiles
WHERE user_id = (SELECT id FROM users WHERE email = 'agent2@test.com');
-- ุงููุชููุน:
-- total_commissions = 75
-- total_businesses = 1
```

---

## ุงูุณููุงุฑูู 3: ุฑูุถ ูุดุงุท

### ุงูุฎุทูุฉ 1: ุฅุถุงูุฉ ูุดุงุท ุฌุฏูุฏ

ุงุณุชุฎุฏู ููุณ ุงูููุฏูุจ (agent2@test.com) ูุฃุถู ูุดุงุท:
```
ุงูุงุณู: ูุชุฌุฑ ุงูุฅููุชุฑูููุงุช
```

### ุงูุฎุทูุฉ 2: ุฑูุถ ุงููุฏูุฑ

1. ุงูุชุญ http://localhost:3003
2. ุงุฐูุจ ุฅูู "ุงูุฃูุดุทุฉ ุงููุนููุฉ"
3. ุงุจุญุซ ุนู "ูุชุฌุฑ ุงูุฅููุชุฑูููุงุช"
4. ุงุถุบุท ุนูู "ุฑูุถ" โ

### ุงูุฎุทูุฉ 3: ุงูุชุญูู

```sql
-- ุงูุชุญูู ูู ุญุงูุฉ ุงููุดุงุท
SELECT status FROM businesses WHERE name_ar = 'ูุชุฌุฑ ุงูุฅููุชุฑูููุงุช';
-- ุงููุชููุน: status = 'REJECTED'

-- ุงูุชุญูู ูู ุงูุนูููุงุช
SELECT COUNT(*) FROM agent_commissions 
WHERE business_id = (SELECT id FROM businesses WHERE name_ar = 'ูุชุฌุฑ ุงูุฅููุชุฑูููุงุช');
-- ุงููุชููุน: 0 (ูุง ุชูุฌุฏ ุนูููุงุช)

-- ุงูุชุญูู ูู ุฅุฌูุงูู ุนูููุงุช ุงูููุฏูุจ (ูุฌุจ ุฃู ูุจูู ููุง ูู)
SELECT total_commissions FROM agent_profiles
WHERE user_id = (SELECT id FROM users WHERE email = 'agent2@test.com');
-- ุงููุชููุน: 75 (ูู ูุชุบูุฑ)
```

---

## ุงูุญุงูุงุช ุงูุฎุงุตุฉ

### 1. ูุดุงุท ุจุฏูู ุจุงูุฌ

**ุงูุงุฎุชุจุงุฑ:**
1. ุฃุถู ูุดุงุท ุชุฌุงุฑู ุจุฏูู ุงุฎุชูุงุฑ ุจุงูุฌ
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุงููุดุงุท ูููุดุฃ ุจูุฌุงุญ
   - ูุง ุชููุดุฃ ุนูููุฉ
   - Console.log: "No package assigned to business: [businessId]"

### 2. ุชูุฑุงุฑ ุงูุนูููุฉ

**ุงูุงุฎุชุจุงุฑ:**
1. ุญุงูู ุฅูุดุงุก ุนูููุฉ ูููุณ ุงููุดุงุท ูุฑุชูู (ุนู ุทุฑูู ุงุณุชุฏุนุงุก API ูุจุงุดุฑุฉ)
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุงูุงุณุชุฏุนุงุก ุงูุฃูู: ููุดุฆ ุงูุนูููุฉ โ
   - ุงูุงุณุชุฏุนุงุก ุงูุซุงูู: ูุนูุฏ ุงูุนูููุฉ ุงูููุฌูุฏุฉ โ๏ธ
   - Console.log: "Commission already exists for business: [businessId]"

---

## ุงุณุชุนูุงูุงุช SQL ูููุฏุฉ

### 1. ุนุฑุถ ุฌููุน ุงูุนูููุงุช

```sql
SELECT 
  ac.id,
  u.email AS agent_email,
  b.name_ar AS business_name,
  ac.subscription_amount,
  ac.commission_rate,
  ac.commission_amount,
  ac.type,
  ac.status,
  ac.approved_at,
  ac.created_at
FROM agent_commissions ac
JOIN agent_profiles ap ON ac.agent_profile_id = ap.id
JOIN users u ON ap.user_id = u.id
JOIN businesses b ON ac.business_id = b.id
ORDER BY ac.created_at DESC;
```

### 2. ุฅุฌูุงูู ุงูุนูููุงุช ููู ููุฏูุจ

```sql
SELECT 
  u.email,
  u.first_name,
  u.last_name,
  ap.total_commissions,
  ap.total_businesses,
  COUNT(ac.id) AS commission_records,
  SUM(CASE WHEN ac.status = 'APPROVED' THEN ac.commission_amount ELSE 0 END) AS approved_amount,
  SUM(CASE WHEN ac.status = 'PAID' THEN ac.commission_amount ELSE 0 END) AS paid_amount
FROM agent_profiles ap
JOIN users u ON ap.user_id = u.id
LEFT JOIN agent_commissions ac ON ap.id = ac.agent_profile_id
GROUP BY u.id, u.email, u.first_name, u.last_name, ap.total_commissions, ap.total_businesses
ORDER BY ap.total_commissions DESC;
```

### 3. ุงูุนูููุงุช ุงููุนููุฉ (APPROVED ูููู ูู ุชูุฏูุน)

```sql
SELECT 
  u.email,
  u.first_name,
  COUNT(ac.id) AS pending_payments,
  SUM(ac.commission_amount) AS total_pending
FROM agent_commissions ac
JOIN agent_profiles ap ON ac.agent_profile_id = ap.id
JOIN users u ON ap.user_id = u.id
WHERE ac.status = 'APPROVED'
GROUP BY u.email, u.first_name
ORDER BY total_pending DESC;
```

### 4. ุฃุญุฏุซ ุงูุฃูุดุทุฉ ูุน ุงูุนูููุงุช

```sql
SELECT 
  b.id,
  b.name_ar,
  b.status AS business_status,
  b.created_at,
  u.email AS agent_email,
  ac.commission_amount,
  ac.status AS commission_status
FROM businesses b
LEFT JOIN users u ON b.agent_id = u.id
LEFT JOIN agent_commissions ac ON b.id = ac.business_id
WHERE b.created_at >= NOW() - INTERVAL '7 days'
ORDER BY b.created_at DESC;
```

---

## ุงููุดุงูู ุงููุญุชููุฉ ูุญููููุง

### โ ุงููุดููุฉ: ุงูุนูููุงุช ูุง ุชุธูุฑ ูู Dashboard

**ุงูุญููู:**
1. ุชุฃูุฏ ูู ุฃู `status = 'APPROVED'` ูู ุฌุฏูู `agent_commissions`
2. ุชุฃูุฏ ูู ุชุญุฏูุซ `total_commissions` ูู ุฌุฏูู `agent_profiles`
3. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ (F5)

### โ ุงููุดููุฉ: ุงูุนูููุฉ = 0

**ุงูุญููู:**
1. ุชุฃูุฏ ูู ุฃู ุงูุจุงูุฌ ูู ุณุนุฑ (price > 0)
2. ุชุฃูุฏ ูู ุฃู ูุณุจุฉ ุนูููุฉ ุงูููุฏูุจ > 0
3. ุฑุงุฌุน console.log ูู terminal

### โ ุงููุดููุฉ: ูุง ุชููุดุฃ ุนูููุฉ ุฃุตูุงู

**ุงูุญููู:**
1. ุชุฃูุฏ ูู ุฃู ุงููุดุงุท ูู `agentId`
2. ุชุฃูุฏ ูู ุฃู ุงููุดุงุท ูู `package` ูุฎุตุต
3. ุงูุชุญ Developer Console โ Network โ ุงุจุญุซ ุนู errors

---

## ููุงุญุธุงุช ูููุฉ

1. **ุงูููุช:**
   - ุงูุนูููุงุช ุชููุดุฃ ููุฑุงู ุจุนุฏ ุงูููุงููุฉ (ุชุฒุงููู)
   - ูุง ููุฌุฏ ุชุฃุฎูุฑ ุฃู cron jobs

2. **ุงูุฃูุงู:**
   - ุฅุฐุง ูุดู ุฅูุดุงุก ุงูุนูููุฉุ ูุง ูุชููู ุงููุธุงู
   - ูุชู ุชุณุฌูู ุงูุฎุทุฃ ูู console.error

3. **ุงูุชูุซูู:**
   - ุฑุงุฌุน `COMMISSIONS_SYSTEM.md` ููุชูุงุตูู ุงููุงููุฉ
   - ุฑุงุฌุน `COMMISSIONS_SUMMARY.md` ููููุฎุต ุงูุณุฑูุน

---

**ุฌุงูุฒ ููุงุฎุชุจุงุฑ! ๐**

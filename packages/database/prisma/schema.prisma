// ===========================================
// النواة الخضراء - الصفحات الخضراء
// Prisma Schema - Green Pages
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum UserRole {
  SUPER_ADMIN  // مدير النظام
  ADMIN        // مدير
  MODERATOR    // مشرف
  AGENT        // مندوب
  BUSINESS     // صاحب نشاط
  USER         // مستخدم عادي
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum BusinessStatus {
  DRAFT          // مسودة
  PENDING        // بانتظار المراجعة
  APPROVED       // معتمد
  REJECTED       // مرفوض
  SUSPENDED      // معلق
  CLOSED         // مغلق
}

enum VerificationStatus {
  UNVERIFIED     // غير موثق
  PENDING        // بانتظار التوثيق
  VERIFIED       // موثق
  REJECTED       // مرفوض
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum AdStatus {
  DRAFT
  PENDING
  ACTIVE
  PAUSED
  EXPIRED
  REJECTED
}

enum AdType {
  BANNER
  FEATURED
  SPONSORED
  POPUP
}

enum AdPosition {
  HOME_TOP
  HOME_MIDDLE
  HOME_BOTTOM
  SIDEBAR
  CATEGORY_TOP
  SEARCH_RESULTS
  BUSINESS_PAGE
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  LOGO
  COVER
  GALLERY
}

enum ProductType {
  PRODUCT    // منتج
  SERVICE    // خدمة
}

enum NotificationType {
  SYSTEM
  BUSINESS
  REVIEW
  AD
  VERIFICATION
}

enum ContactType {
  PHONE
  MOBILE
  WHATSAPP
  EMAIL
  WEBSITE
  FACEBOOK
  INSTAGRAM
  TWITTER
  LINKEDIN
  YOUTUBE
  TIKTOK
  TELEGRAM
  OTHER
}

// ===========================================
// USER & AUTHENTICATION
// ===========================================

model User {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email           String       @unique
  phone           String       @unique  // Required field
  password        String
  role            UserRole     @default(USER)
  status          UserStatus   @default(ACTIVE)
  
  // Profile
  firstName       String       @map("first_name")  // Required field
  lastName        String       @map("last_name")   // Required field
  displayName     String?      @map("display_name")
  avatar          String?
  bio             String?
  
  // Address - Required for targeting
  governorateId   String?      @map("governorate_id") @db.Uuid
  cityId          String?      @map("city_id") @db.Uuid
  districtId      String?      @map("district_id") @db.Uuid
  addressLine     String?      @map("address_line")
  
  // Verification
  emailVerified   Boolean      @default(false) @map("email_verified")
  phoneVerified   Boolean      @default(false) @map("phone_verified")
  verifiedAt      DateTime?    @map("verified_at")
  
  // Metadata
  lastLoginAt     DateTime?    @map("last_login_at")
  lastLoginIp     String?      @map("last_login_ip")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")
  
  // Relations
  governorate     Governorate? @relation(fields: [governorateId], references: [id], onDelete: SetNull)
  city            City?        @relation(fields: [cityId], references: [id], onDelete: SetNull)
  district        District?    @relation(fields: [districtId], references: [id], onDelete: SetNull)
  sessions        Session[]
  businesses      Business[]        @relation("BusinessOwner")
  agentBusinesses Business[]        @relation("BusinessAgent")
  reviews         Review[]
  notifications   Notification[]
  createdBusinesses Business[]      @relation("BusinessCreator")
  businessPersons BusinessPerson[]
  activityLogs    ActivityLog[]
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
  @@index([governorateId])
  @@index([cityId])
  @@index([districtId])
  @@map("users")
}

model Session {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  token        String    @unique
  refreshToken String?   @unique @map("refresh_token")
  userAgent    String?   @map("user_agent")
  ipAddress    String?   @map("ip_address")
  expiresAt    DateTime  @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model PasswordReset {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([email])
  @@index([token])
  @@map("password_resets")
}

// OTP للتحقق من رقم الهاتف
model PhoneOtp {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  phone     String
  code      String
  purpose   OtpPurpose @default(VERIFY_PHONE)
  attempts  Int       @default(0)
  verified  Boolean   @default(false)
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  
  @@index([phone])
  @@index([phone, code])
  @@map("phone_otps")
}

enum OtpPurpose {
  VERIFY_PHONE
  RESET_PASSWORD
  LOGIN
}

// ===========================================
// GEOGRAPHY
// ===========================================

model Governorate {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  slug         String   @unique
  nameAr       String   @map("name_ar")
  nameEn       String?  @map("name_en")
  description  String?
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  sortOrder    Int      @default(0) @map("sort_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  cities       City[]
  businesses   Business[]
  users        User[]
  adTargets    AdGovernorate[] // الإعلانات المستهدفة لهذه المحافظة
  
  @@index([slug])
  @@index([isActive])
  @@index([sortOrder])
  @@map("governorates")
}

model City {
  id            String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  governorateId String      @map("governorate_id") @db.Uuid
  slug          String      @unique
  nameAr        String      @map("name_ar")
  nameEn        String?     @map("name_en")
  description   String?
  latitude      Decimal?    @db.Decimal(10, 8)
  longitude     Decimal?    @db.Decimal(11, 8)
  sortOrder     Int         @default(0) @map("sort_order")
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  governorate   Governorate @relation(fields: [governorateId], references: [id], onDelete: Cascade)
  districts     District[]
  businesses    Business[]
  branches      BusinessBranch[]
  users         User[]
  adTargets     AdCity[] // الإعلانات المستهدفة لهذه المدينة
  
  @@index([governorateId])
  @@index([slug])
  @@index([isActive])
  @@index([sortOrder])
  @@map("cities")
}

model District {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cityId      String   @map("city_id") @db.Uuid
  slug        String   @unique
  nameAr      String   @map("name_ar")
  nameEn      String?  @map("name_en")
  description String?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  city        City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  businesses  Business[]
  branches    BusinessBranch[]
  users       User[]
  
  @@index([cityId])
  @@index([slug])
  @@index([isActive])
  @@index([sortOrder])
  @@map("districts")
}

// ===========================================
// CATEGORIES
// ===========================================

model Category {
  id            String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  parentId      String?    @map("parent_id") @db.Uuid
  slug          String     @unique
  nameAr        String     @map("name_ar")
  nameEn        String?    @map("name_en")
  descriptionAr String?    @map("description_ar")
  descriptionEn String?    @map("description_en")
  icon          String?
  image         String?
  color         String?
  sortOrder     Int        @default(0) @map("sort_order")
  isActive      Boolean    @default(true) @map("is_active")
  isFeatured    Boolean    @default(false) @map("is_featured")
  metaTitleAr   String?    @map("meta_title_ar")
  metaTitleEn   String?    @map("meta_title_en")
  metaDescAr    String?    @map("meta_desc_ar")
  metaDescEn    String?    @map("meta_desc_en")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  
  parent        Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children      Category[] @relation("CategoryHierarchy")
  businesses    BusinessCategory[]
  
  @@index([parentId])
  @@index([slug])
  @@index([isActive])
  @@index([isFeatured])
  @@index([sortOrder])
  @@map("categories")
}

// ===========================================
// BUSINESS (النشاط التجاري)
// ===========================================

model Business {
  id                 String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  
  // Basic Info (Translatable)
  slug               String             @unique
  nameAr             String             @map("name_ar")
  nameEn             String?            @map("name_en")
  descriptionAr      String?            @map("description_ar") @db.Text
  descriptionEn      String?            @map("description_en") @db.Text
  shortDescAr        String?            @map("short_desc_ar")
  shortDescEn        String?            @map("short_desc_en")
  
  // Branding
  logo               String?
  cover              String?
  
  // Location (Main)
  governorateId      String             @map("governorate_id") @db.Uuid
  cityId             String             @map("city_id") @db.Uuid
  districtId         String?            @map("district_id") @db.Uuid
  addressAr          String?            @map("address_ar")
  addressEn          String?            @map("address_en")
  latitude           Decimal?           @db.Decimal(10, 8)
  longitude          Decimal?           @db.Decimal(11, 8)
  
  // Status
  status             BusinessStatus     @default(DRAFT)
  verificationStatus VerificationStatus @default(UNVERIFIED) @map("verification_status")
  verifiedAt         DateTime?          @map("verified_at")
  
  // Flags
  isFeatured         Boolean            @default(false) @map("is_featured")
  isVerified         Boolean            @default(false) @map("is_verified")
  isActive           Boolean            @default(true) @map("is_active")
  
  // Statistics (Denormalized for performance)
  viewsCount         Int                @default(0) @map("views_count")
  reviewsCount       Int                @default(0) @map("reviews_count")
  averageRating      Decimal            @default(0) @db.Decimal(2, 1) @map("average_rating")
  
  // SEO
  metaTitleAr        String?            @map("meta_title_ar")
  metaTitleEn        String?            @map("meta_title_en")
  metaDescAr         String?            @map("meta_desc_ar")
  metaDescEn         String?            @map("meta_desc_en")
  metaKeywordsAr     String?            @map("meta_keywords_ar")
  metaKeywordsEn     String?            @map("meta_keywords_en")
  
  // Ownership
  ownerId            String?            @map("owner_id") @db.Uuid
  agentId            String?            @map("agent_id") @db.Uuid
  createdById        String?            @map("created_by_id") @db.Uuid
  
  // Timestamps
  publishedAt        DateTime?          @map("published_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  deletedAt          DateTime?          @map("deleted_at")
  
  // Relations
  governorate        Governorate        @relation(fields: [governorateId], references: [id])
  city               City               @relation(fields: [cityId], references: [id])
  district           District?          @relation(fields: [districtId], references: [id])
  owner              User?              @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  agent              User?              @relation("BusinessAgent", fields: [agentId], references: [id], onDelete: SetNull)
  createdBy          User?              @relation("BusinessCreator", fields: [createdById], references: [id], onDelete: SetNull)
  
  categories         BusinessCategory[]
  branches           BusinessBranch[]
  workingHours       BusinessWorkingHours[]
  contacts           BusinessContact[]
  media              BusinessMedia[]
  persons            BusinessPerson[]
  products           BusinessProduct[]
  reviews            Review[]
  ads                Ad[]
  views              BusinessView[]
  package            BusinessPackage?

  @@index([slug])
  @@index([status])
  @@index([verificationStatus])
  @@index([governorateId])
  @@index([cityId])
  @@index([districtId])
  @@index([ownerId])
  @@index([agentId])
  @@index([isFeatured])
  @@index([isVerified])
  @@index([isActive])
  @@index([averageRating])
  @@index([createdAt])
  @@index([status, governorateId])
  @@index([status, cityId])
  @@index([status, isFeatured])
  @@index([status, isVerified])
  @@map("businesses")
}

model BusinessCategory {
  businessId String   @map("business_id") @db.Uuid
  categoryId String   @map("category_id") @db.Uuid
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at")
  
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([categoryId])
  @@index([isPrimary])
  @@index([createdAt])
  @@id([businessId, categoryId])
  @@map("business_categories")
}

model BusinessBranch {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId  String    @map("business_id") @db.Uuid
  nameAr      String    @map("name_ar")
  nameEn      String?   @map("name_en")
  cityId      String    @map("city_id") @db.Uuid
  districtId  String?   @map("district_id") @db.Uuid
  addressAr   String?   @map("address_ar")
  addressEn   String?   @map("address_en")
  latitude    Decimal?  @db.Decimal(10, 8)
  longitude   Decimal?  @db.Decimal(11, 8)
  phone       String?
  isMain      Boolean   @default(false) @map("is_main")
  isActive    Boolean   @default(true) @map("is_active")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  city        City      @relation(fields: [cityId], references: [id])
  district    District? @relation(fields: [districtId], references: [id])
  workingHours BusinessWorkingHours[]
  contacts    BusinessContact[]
  
  @@index([businessId])
  @@index([cityId])
  @@index([districtId])
  @@index([isActive])
  @@index([sortOrder])
  @@map("business_branches")
}

model BusinessWorkingHours {
  id          String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId  String          @map("business_id") @db.Uuid
  branchId    String?         @map("branch_id") @db.Uuid
  dayOfWeek   DayOfWeek       @map("day_of_week")
  openTime    String?         @map("open_time")  // Format: "HH:mm"
  closeTime   String?         @map("close_time") // Format: "HH:mm"
  isClosed    Boolean         @default(false) @map("is_closed")
  is24Hours   Boolean         @default(false) @map("is_24_hours")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  business    Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  branch      BusinessBranch? @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, branchId, dayOfWeek])
  @@index([businessId])
  @@index([branchId])
  @@map("business_working_hours")
}

model BusinessContact {
  id          String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId  String          @map("business_id") @db.Uuid
  branchId    String?         @map("branch_id") @db.Uuid
  type        ContactType
  value       String
  label       String?
  isPrimary   Boolean         @default(false) @map("is_primary")
  isPublic    Boolean         @default(true) @map("is_public")
  sortOrder   Int             @default(0) @map("sort_order")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  business    Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  branch      BusinessBranch? @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([branchId])
  @@index([type])
  @@map("business_contacts")
}

model BusinessMedia {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId  String    @map("business_id") @db.Uuid
  type        MediaType
  url         String
  thumbnailUrl String?  @map("thumbnail_url")
  titleAr     String?   @map("title_ar")
  titleEn     String?   @map("title_en")
  altAr       String?   @map("alt_ar")
  altEn       String?   @map("alt_en")
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([type])
  @@map("business_media")
}

model BusinessPerson {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId  String    @map("business_id") @db.Uuid
  userId      String?   @map("user_id") @db.Uuid
  nameAr      String    @map("name_ar")
  nameEn      String?   @map("name_en")
  positionAr  String?   @map("position_ar")
  positionEn  String?   @map("position_en")
  bioAr       String?   @map("bio_ar")
  bioEn       String?   @map("bio_en")
  photo       String?
  phone       String?
  email       String?
  isPublic    Boolean   @default(true) @map("is_public")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([businessId])
  @@index([userId])
  @@index([sortOrder])
  @@map("business_persons")
}

model BusinessProduct {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId    String       @map("business_id") @db.Uuid
  type          ProductType  @default(PRODUCT)
  nameAr        String       @map("name_ar")
  nameEn        String?      @map("name_en")
  descriptionAr String?      @map("description_ar") @db.Text
  descriptionEn String?      @map("description_en") @db.Text
  image         String?
  price         Decimal?     @db.Decimal(12, 2)
  currency      String?      @default("SYP") // SYP, USD, EUR
  priceNote     String?      @map("price_note") // مثال: "يبدأ من" أو "حسب الطلب"
  isAvailable   Boolean      @default(true) @map("is_available")
  isFeatured    Boolean      @default(false) @map("is_featured")
  sortOrder     Int          @default(0) @map("sort_order")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  
  business      Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([type])
  @@index([isAvailable])
  @@index([isFeatured])
  @@map("business_products")
}

model BusinessView {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId String   @map("business_id") @db.Uuid
  date       DateTime @default(now()) @db.Date
  count      Int      @default(1)
  
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, date])
  @@index([date])
  @@map("business_views")
}

// ===========================================
// REVIEWS
// ===========================================

model Review {
  id          String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId  String       @map("business_id") @db.Uuid
  userId      String       @map("user_id") @db.Uuid
  rating      Int          // 1-5
  titleAr     String?      @map("title_ar")
  titleEn     String?      @map("title_en")
  contentAr   String?      @map("content_ar") @db.Text
  contentEn   String?      @map("content_en") @db.Text
  pros        String[]     @default([])
  cons        String[]     @default([])
  status      ReviewStatus @default(PENDING)
  isVerified  Boolean      @default(false) @map("is_verified")
  helpfulCount Int         @default(0) @map("helpful_count")
  reportCount Int          @default(0) @map("report_count")
  ipAddress   String?      @map("ip_address")
  userAgent   String?      @map("user_agent")
  replyAr     String?      @map("reply_ar") @db.Text
  replyEn     String?      @map("reply_en") @db.Text
  repliedAt   DateTime?    @map("replied_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  
  business    Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([userId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

// ===========================================
// ADVERTISEMENTS
// ===========================================

model Ad {
  id           String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId   String?    @map("business_id") @db.Uuid
  type         AdType
  position     AdPosition
  titleAr      String     @map("title_ar")
  titleEn      String?    @map("title_en")
  descriptionAr String?   @map("description_ar")
  descriptionEn String?   @map("description_en")
  imageDesktop String?    @map("image_desktop")
  imageMobile  String?    @map("image_mobile")
  linkUrl      String?    @map("link_url")
  status       AdStatus   @default(DRAFT)
  priority     Int        @default(0)
  startDate    DateTime   @map("start_date")
  endDate      DateTime   @map("end_date")
  impressions  Int        @default(0)
  clicks       Int        @default(0)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  
  // Geographic Targeting - الاستهداف الجغرافي
  // إذا كانت فارغة = يظهر للجميع، إذا محددة = يظهر فقط لهذه المناطق
  targetAllLocations Boolean @default(true) @map("target_all_locations") // استهداف كل المواقع
  
  business     Business?  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  targetGovernorates AdGovernorate[] // المحافظات المستهدفة
  targetCities       AdCity[]        // المدن المستهدفة
  
  @@index([businessId])
  @@index([status])
  @@index([type])
  @@index([position])
  @@index([startDate])
  @@index([endDate])
  @@index([targetAllLocations])
  @@map("ads")
}

// جدول وسيط للمحافظات المستهدفة في الإعلان
model AdGovernorate {
  id            String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  adId          String      @map("ad_id") @db.Uuid
  governorateId String      @map("governorate_id") @db.Uuid
  
  ad            Ad          @relation(fields: [adId], references: [id], onDelete: Cascade)
  governorate   Governorate @relation(fields: [governorateId], references: [id], onDelete: Cascade)
  
  @@unique([adId, governorateId])
  @@index([adId])
  @@index([governorateId])
  @@map("ad_governorates")
}

// جدول وسيط للمدن المستهدفة في الإعلان
model AdCity {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  adId   String @map("ad_id") @db.Uuid
  cityId String @map("city_id") @db.Uuid
  
  ad     Ad     @relation(fields: [adId], references: [id], onDelete: Cascade)
  city   City   @relation(fields: [cityId], references: [id], onDelete: Cascade)
  
  @@unique([adId, cityId])
  @@index([adId])
  @@index([cityId])
  @@map("ad_cities")
}

// ===========================================
// NOTIFICATIONS
// ===========================================

model Notification {
  id          String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String           @map("user_id") @db.Uuid
  type        NotificationType
  titleAr     String           @map("title_ar")
  titleEn     String?          @map("title_en")
  messageAr   String           @map("message_ar")
  messageEn   String?          @map("message_en")
  data        Json?
  isRead      Boolean          @default(false) @map("is_read")
  readAt      DateTime?        @map("read_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// ===========================================
// SETTINGS
// ===========================================

model Setting {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  key         String   @unique
  valueAr     String?  @map("value_ar") @db.Text
  valueEn     String?  @map("value_en") @db.Text
  type        String   @default("text") // text, textarea, number, boolean, json, image
  group       String   @default("general")
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([key])
  @@index([group])
  @@map("settings")
}

// ===========================================
// PAGES (Static Pages)
// ===========================================

model Page {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  slug        String   @unique
  titleAr     String   @map("title_ar")
  titleEn     String?  @map("title_en")
  contentAr   String   @map("content_ar") @db.Text
  contentEn   String?  @map("content_en") @db.Text
  metaTitleAr String?  @map("meta_title_ar")
  metaTitleEn String?  @map("meta_title_en")
  metaDescAr  String?  @map("meta_desc_ar")
  metaDescEn  String?  @map("meta_desc_en")
  isPublished Boolean  @default(false) @map("is_published")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([slug])
  @@index([isPublished])
  @@map("pages")
}

// ===========================================
// SUBSCRIPTION PACKAGES (نظام الباقات)
// ===========================================

enum PackageStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum FeatureKey {
  AD_ALLOWED              // السماح بالإعلانات
  VERIFIED_BADGE          // شارة التحقق
  FEATURED_LISTING        // ظهور في القائمة المميزة
  CUSTOM_LINKS            // روابط مخصصة
  PRIORITY_SUPPORT        // دعم فني ذو أولوية
  ANALYTICS_DASHBOARD     // لوحة إحصائيات متقدمة
  UNLIMITED_PHOTOS        // صور غير محدودة
}

enum LimitKey {
  MAX_BRANCHES            // الحد الأقصى للفروع
  MAX_PERSONS             // الحد الأقصى للأشخاص
  MAX_ADS                 // الحد الأقصى للإعلانات النشطة
  MAX_GALLERY_PHOTOS      // الحد الأقصى للصور في المعرض
  MAX_PRODUCTS            // الحد الأقصى للمنتجات/الخدمات
}

model Package {
  id            String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  nameAr        String         @map("name_ar")
  nameEn        String?        @map("name_en")
  slug          String         @unique
  descriptionAr String?        @map("description_ar") @db.Text
  descriptionEn String?        @map("description_en") @db.Text
  price         Decimal        @db.Decimal(12, 2)
  durationDays  Int            @map("duration_days") // المدة بالأيام
  status        PackageStatus  @default(ACTIVE)
  isPublic      Boolean        @default(true) @map("is_public")
  isDefault     Boolean        @default(false) @map("is_default") // الباقة الافتراضية عند انتهاء الاشتراك
  sortOrder     Int            @default(0) @map("sort_order")
  
  features      PackageFeature[]
  limits        PackageLimit[]
  businessPackages BusinessPackage[]
  
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@index([status])
  @@index([isPublic])
  @@index([isDefault])
  @@index([sortOrder])
  @@map("packages")
}

model PackageFeature {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  packageId   String     @map("package_id") @db.Uuid
  featureKey  FeatureKey @map("feature_key")
  isEnabled   Boolean    @default(true) @map("is_enabled")
  
  package     Package    @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([packageId, featureKey])
  @@map("package_features")
}

model PackageLimit {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  packageId   String   @map("package_id") @db.Uuid
  limitKey    LimitKey @map("limit_key")
  limitValue  Int      @map("limit_value")
  
  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([packageId, limitKey])
  @@map("package_limits")
}

model BusinessPackage {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessId    String    @map("business_id") @db.Uuid @unique
  packageId     String    @map("package_id") @db.Uuid
  startDate     DateTime  @default(now()) @map("start_date")
  endDate       DateTime? @map("end_date")
  isActive      Boolean   @default(true) @map("is_active")
  autoRenew     Boolean   @default(false) @map("auto_renew")
  
  // Admin Override Fields - حقول التجاوز الإداري
  overrideEnabled   Boolean   @default(false) @map("override_enabled") // هل التجاوز مفعل؟
  overrideReason    String?   @map("override_reason") // سبب التجاوز
  overrideExpiresAt DateTime? @map("override_expires_at") // تاريخ انتهاء التجاوز
  overrideByUserId  String?   @map("override_by_user_id") @db.Uuid // من قام بالتجاوز
  
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  package       Package   @relation(fields: [packageId], references: [id])
  history       PackageHistory[]

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([businessId])
  @@index([packageId])
  @@index([isActive])
  @@index([overrideEnabled])
  @@map("business_packages")
}

model PackageHistory {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  businessPackageId String   @map("business_package_id") @db.Uuid
  packageId         String   @map("package_id") @db.Uuid
  action            String   // UPGRADE, DOWNGRADE, RENEWAL, CANCEL
  oldPackageId      String?  @map("old_package_id") @db.Uuid
  price             Decimal  @db.Decimal(12, 2)
  startDate         DateTime @map("start_date")
  endDate           DateTime @map("end_date")
  createdAt         DateTime @default(now()) @map("created_at")
  
  businessPackage   BusinessPackage @relation(fields: [businessPackageId], references: [id], onDelete: Cascade)

  @@map("package_history")
}
// ===========================================
// ACTIVITY LOG
// ===========================================

model ActivityLog {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  action      String
  entity      String
  entityId    String?  @map("entity_id")
  oldData     Json?    @map("old_data")
  newData     Json?    @map("new_data")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
  @@index([entity, entityId])
  @@map("activity_logs")
}

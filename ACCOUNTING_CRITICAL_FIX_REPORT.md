# ุชูุฑูุฑ ุงูุฅุตูุงุญ ุงูุฌุฐุฑู ูููุธุงู ุงููุญุงุณุจู ๐ง
## Critical Accounting System Fix Report

**ุงูุชุงุฑูุฎ:** 7 ููุงูุฑ 2026  
**ุงูุญุงูุฉ:** โ ุชู ุงูุฅุตูุงุญ ุงููุงูู

---

## ๐จ ุงููุดุงูู ุงูุญุฑุฌุฉ ุงูููุชุดูุฉ

### 1๏ธโฃ ุนุฏู ุฅูุดุงุก ููุงุชูุฑ ุนูุฏ ุงูุฏูุน

**ุงููุตู:**
- ุนูุฏ ุฏูุน ุงุดุชุฑุงู ูู ุงููุญูุธุฉุ ูุงู ูุชู ุชุณุฌูู ููุฏ ูุญุงุณุจู ููุท
- **ูุง ูุชู ุฅูุดุงุก ูุงุชูุฑุฉ ููุนููู**
- ูุฐุง ูุฎุงูู ุงููุนุงููุฑ ุงููุญุงุณุจูุฉ ูุงููุงููููุฉ

**ุงูุชุฃุซูุฑ:**
- โ ูุง ููุฌุฏ ุณุฌู ุฑุณูู ูููุนุงููุฉ (ูุงุชูุฑุฉ)
- โ ูุง ูููู ููุนููู ุงูุญุตูู ุนูู ูุงุชูุฑุฉ
- โ ุตุนูุจุฉ ูู ุงูุชุฏููู ูุงููุฑุงุฌุนุฉ
- โ ูุดุงูู ูุงููููุฉ ูุญุชููุฉ

### 2๏ธโฃ ุงูููุฏ ุงููุญุงุณุจู ูููุตู ุนู ุงููุงุชูุฑุฉ

**ุงููุตู:**
- ุงูููุฏ ุงููุญุงุณุจู ูุงู ูููุดุฃ ูุจุงุดุฑุฉ ุจุฏูู ุฑุจุทู ุจูุงุชูุฑุฉ
- ุงููุธุงู ุงููุญุงุณุจู ุงูุตุญูุญ: **ุงููุงุชูุฑุฉ ุฃููุงู ุซู ุงูููุฏ**

**ุงูุชุฃุซูุฑ:**
- โ ุนุฏู ุฑุจุท ุงููููุฏ ุจุงูููุงุชูุฑ
- โ ุตุนูุจุฉ ุงูุชุชุจุน ูุงูุชุฏููู
- โ ุนุฏู ุชูุงูู ูุน ุงููุนุงููุฑ ุงููุญุงุณุจูุฉ

### 3๏ธโฃ ุนุฏู ูุถูุญ ูู ุชุฏูู ุงูุจูุงูุงุช

**ุงููุตู:**
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุบูุฑ ูุงุถุญุฉ
- ุนุฏู ุฅุฑุฌุงุน ูุนูููุงุช ุงููุงุชูุฑุฉ ูุงูููุฏ ูููุณุชุฎุฏู

---

## โ ุงูุญููู ุงููุทุจูุฉ

### ุงูุญู 1: ุฅุนุงุฏุฉ ููููุฉ `recordWalletPayment`

**ุงูููู:** `apps/api/src/modules/wallet/wallet-accounting.bridge.ts`

**ูุจู:**
```typescript
async recordWalletPayment(...): Promise<void> {
  // ุฅูุดุงุก ููุฏ ูุญุงุณุจู ูุจุงุดุฑุฉ
  await this.accountingService.createJournalEntry(...);
}
```

**ุจุนุฏ:**
```typescript
async recordWalletPayment(...): Promise<{ journalEntryId: string; invoiceId: string }> {
  // 1๏ธโฃ ุฅูุดุงุก ุงููุงุชูุฑุฉ ุฃููุงู
  const invoice = await this.accountingService.createInvoice(userId, {
    customerId: walletOwnerId,
    customerName: customerName || 'ุนููู',
    customerEmail,
    customerPhone,
    businessId,
    invoiceType: 'SALE',
    dueDate: new Date(),
    lines: [{
      description: referenceName,
      quantity: 1,
      unitPrice: netAmount,
    }],
  });

  // 2๏ธโฃ ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ (ุชุบููุฑ ุงูุญุงูุฉ ูู DRAFT ุฅูู ISSUED)
  // ูุฐุง ููุดุฆ ุงูููุฏ ุงููุญุงุณุจู ุชููุงุฆูุงู
  await this.accountingService.issueInvoice(invoice.id, userId);

  // 3๏ธโฃ ุชุณุฌูู ุงูุฏูุน ูุจุงุดุฑุฉู (ุงููุงุชูุฑุฉ ูุฏููุนุฉ ุจุงููุงูู)
  await this.accountingService.recordInvoicePayment(
    invoice.id,
    userId,
    grossAmount,
    'WALLET',
  );

  // 4๏ธโฃ ุฅุฑุฌุงุน ูุนูููุงุช ุงููุงุชูุฑุฉ ูุงูููุฏ
  return {
    journalEntryId: invoice.journalEntryId || '',
    invoiceId: invoice.id,
  };
}
```

**ุงูููุงุฆุฏ:**
- โ ุฅูุดุงุก ูุงุชูุฑุฉ ููู ุนูููุฉ ุฏูุน
- โ ุงูููุฏ ูุฑุจูุท ุจุงููุงุชูุฑุฉ
- โ ุงููุงุชูุฑุฉ ุชูุตุฏุฑ ูุชูุฏูุน ุชููุงุฆูุงู
- โ ุฅุฑุฌุงุน ูุนูููุงุช ูุงููุฉ

---

### ุงูุญู 2: ุชุญุฏูุซ `wallet.service.ts`

**ุงูููู:** `apps/api/src/modules/wallet/wallet.service.ts`

**ุงูุชุญุณููุงุช:**

#### ุฃ) ุฅุถุงูุฉ ุจูุงูุงุช ุงูุนููู ูููุงุชูุฑุฉ

```typescript
// ุงูุญุตูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู ูููุงุชูุฑุฉ
const user = await this.prisma.user.findUnique({
  where: { id: wallet.userId },
  select: { firstName: true, lastName: true, email: true, phone: true },
});

const accountingResult = await this.accountingBridge.recordWalletPayment({
  // ... ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
  customerName: user ? `${user.firstName} ${user.lastName}` : 'ุนููู',
  customerEmail: user?.email,
  customerPhone: user?.phone,
});
```

#### ุจ) ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

```typescript
let invoiceId: string | undefined;
let journalEntryId: string | undefined;

try {
  const accountingResult = await this.accountingBridge.recordWalletPayment(...);
  invoiceId = accountingResult.invoiceId;
  journalEntryId = accountingResult.journalEntryId;
} catch (error) {
  console.error('โ๏ธ ูุดู ุชุณุฌูู ุงูููุฏ ุงููุญุงุณุจู ูุฅูุดุงุก ุงููุงุชูุฑุฉ:', error);
  // ูุง ูููู ุงูุนูููุฉุ ูููู ูุณุฌู ุงูุฎุทุฃ
}
```

#### ุฌ) ุฅุฑุฌุงุน ูุนูููุงุช ุงููุญุงุณุจุฉ

```typescript
return {
  success: true,
  transaction: { id, amount, balanceAfter },
  subscription: { packageName, startDate, endDate },
  discount: { remainingDays, remainingValue, originalPrice },
  accounting: {
    invoiceId,      // โ ุฌุฏูุฏ
    journalEntryId, // โ ุฌุฏูุฏ
  },
};
```

---

## ๐ ุงูุชุฏูู ุงูุฌุฏูุฏ ููุจูุงูุงุช

### ุณููุงุฑูู: ูุณุชุฎุฏู ูุฌุฏุฏ ุจุงูุชู

```
1. User โ ูุฎุชุงุฑ ุงูุชุฌุฏูุฏ
   โ
2. Frontend โ POST /wallet/pay
   โ
3. WalletService.payFromWallet()
   โโ ุญุณุงุจ ุฎุตู ุงูุฃูุงู ุงููุชุจููุฉ
   โโ ุงูุชุญูู ูู ุงูุฑุตูุฏ
   โโ $transaction
      โโ ุฎุตู ูู ุงููุญูุธุฉ
      โโ ุฅูุดุงุก WalletTransaction
   โ
4. PackagesService.assignPackage()
   โโ ุชุญุฏูุซ BusinessPackage (ุงูุชูุฏูุฏ ูู ุชุงุฑูุฎ ุงูุงูุชูุงุก ุงูุญุงูู)
   โโ ุฅูุดุงุก PackageHistory (RENEWAL)
   โโ ุฅูุดุงุก AgentCommission
   โ
5. WalletAccountingBridge.recordWalletPayment()
   โโ ๐ ุฅูุดุงุก ูุงุชูุฑุฉ (AccInvoice - DRAFT)
   โโ โ ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ (ISSUED) โ ููุดุฆ ููุฏ ูุญุงุณุจู
   โโ ๐ฐ ุชุณุฌูู ุงูุฏูุน (PAID) โ ููุฏ ุฏูุน
   โ
6. Success โ
   โโ ุฅุฑุฌุงุน invoiceId & journalEntryId
```

---

## ๐ ุงููุซุงุฆู ุงููุญุงุณุจูุฉ ุงูููุดุฃุฉ

### ููู ุนูููุฉ ุฏูุน ุงุดุชุฑุงูุ ูุชู ุฅูุดุงุก:

1. **AccInvoice (ูุงุชูุฑุฉ)**
   - ุฑูู ุงููุงุชูุฑุฉ: `INV-YYYYMM-XXXX`
   - ุงูููุน: `SALE`
   - ุงูุญุงูุฉ: `PAID` (ูุฏููุนุฉ)
   - ุงูุนููู: ุจูุงูุงุช ุงููุณุชุฎุฏู ูุงููุฉ
   - ุงูุฃุณุทุฑ: ุชูุงุตูู ุงูุจุงูุฉ

2. **AccJournalEntry (ููุฏ ุงูุฅุตุฏุงุฑ)**
   - ุนูุฏ ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ:
   ```
   ูู ุญู/ ุญุณุงุจุงุช ูุฏููุฉ (ACCOUNTS_RECEIVABLE)
     ุฅูู ุญู/ ุฅูุฑุงุฏ ุงูุงุดุชุฑุงูุงุช (SUBSCRIPTION_REVENUE)
   ```

3. **AccJournalEntry (ููุฏ ุงูุฏูุน)**
   - ุนูุฏ ุชุณุฌูู ุงูุฏูุน:
   ```
   ูู ุญู/ ุงููุญูุธุฉ (WALLET)
     ุฅูู ุญู/ ุญุณุงุจุงุช ูุฏููุฉ (ACCOUNTS_RECEIVABLE)
   ```

4. **AccInvoicePayment (ุณุฌู ุงูุฏูุน)**
   - ุทุฑููุฉ ุงูุฏูุน: `WALLET`
   - ุงููุจูุบ ุงููุฏููุน: ุงููุจูุบ ุงููุงูู
   - ุงูุชุงุฑูุฎ: ุชุงุฑูุฎ ุงูุนูููุฉ

---

## ๐งช ุงูุชุญูู ูู ุงูุฅุตูุงุญ

### SQL ููุชุญูู ูู ุฅูุดุงุก ุงูููุงุชูุฑ:

```sql
-- 1. ุงูุชุญูู ูู ุงูููุงุชูุฑ ุงูููุดุฃุฉ
SELECT 
  i.id,
  i.invoice_number,
  i.invoice_type,
  i.status,
  i.customer_name,
  i.total,
  i.paid_amount,
  i.invoice_date,
  i.created_at
FROM acc_invoices i
WHERE i.customer_id = 'USER_ID'
  AND i.invoice_type = 'SALE'
ORDER BY i.created_at DESC;

-- 2. ุงูุชุญูู ูู ุฃุณุทุฑ ุงููุงุชูุฑุฉ
SELECT 
  il.description,
  il.description_ar,
  il.quantity,
  il.unit_price,
  il.subtotal,
  il.tax_amount,
  il.total
FROM acc_invoice_lines il
WHERE il.invoice_id = 'INVOICE_ID';

-- 3. ุงูุชุญูู ูู ุฑุจุท ุงููุงุชูุฑุฉ ุจุงูููุฏ
SELECT 
  i.invoice_number,
  i.status,
  je.description_ar,
  je.status as entry_status,
  je.posted_at
FROM acc_invoices i
LEFT JOIN acc_journal_entries je ON je.id = i.journal_entry_id
WHERE i.id = 'INVOICE_ID';

-- 4. ุงูุชุญูู ูู ุงูุฏูุนุงุช
SELECT 
  ip.payment_date,
  ip.amount,
  ip.payment_method,
  ip.journal_entry_id
FROM acc_invoice_payments ip
WHERE ip.invoice_id = 'INVOICE_ID'
ORDER BY ip.payment_date DESC;

-- 5. ุฅุญุตุงุฆูุงุช ุดุงููุฉ
SELECT 
  COUNT(*) as total_invoices,
  SUM(total) as total_amount,
  SUM(paid_amount) as paid_amount,
  COUNT(CASE WHEN status = 'PAID' THEN 1 END) as paid_invoices
FROM acc_invoices
WHERE customer_id = 'USER_ID'
  AND invoice_type = 'SALE';
```

---

## ๐ ุงูููุงุฆุฏ ุงูุฅุฌูุงููุฉ

### โ ุงูุงูุชุซุงู ุงููุญุงุณุจู

1. **ููุงุชูุฑ ุฑุณููุฉ**
   - ูู ุนูููุฉ ููุง ูุงุชูุฑุฉ ุฑุณููุฉ
   - ุฃุฑูุงู ุชุณูุณููุฉ ููุธูุฉ
   - ุจูุงูุงุช ูุงููุฉ ููุนููู

2. **ูููุฏ ูุญุงุณุจูุฉ ูุฑุชุจุทุฉ**
   - ูู ูุงุชูุฑุฉ ูุฑุจูุทุฉ ุจููุฏ ูุญุงุณุจู
   - ุณูููุฉ ุงูุชุฏููู ูุงููุฑุงุฌุนุฉ
   - ุชูุงูู ูุน ุงููุนุงููุฑ ุงูุฏูููุฉ

3. **ุณุฌู ุฏูุนุงุช ููุซู**
   - ุชุชุจุน ุฌููุน ุงูุฏูุนุงุช
   - ุทุฑููุฉ ุงูุฏูุน ูุญุฏุฏุฉ (WALLET)
   - ุชูุงุฑูุฎ ุฏูููุฉ

### โ ุงูุดูุงููุฉ ูููุณุชุฎุฏู

- ูููู ูููุณุชุฎุฏู ุงูุญุตูู ุนูู ูุงุชูุฑุฉ ุฑุณููุฉ
- ูููู ุทุจุงุนุฉ ุฃู ุชูุฒูู ุงูููุงุชูุฑ
- ุณุฌู ูุงูู ููุนูููุงุช

### โ ุงูุชุฏููู ูุงููุฑุงุฌุนุฉ

- ุณูููุฉ ุชุชุจุน ุฌููุน ุงูุนูููุงุช ุงููุงููุฉ
- ุฑุจุท ูุงุถุญ ุจูู ุงูููุงุชูุฑ ูุงููููุฏ
- ุชูุงุฑูุฑ ูุญุงุณุจูุฉ ุฏูููุฉ

---

## ๐ ููุงุฑูุฉ ูุจู/ุจุนุฏ

| ุงูุฌุงูุจ | ูุจู ุงูุฅุตูุงุญ | ุจุนุฏ ุงูุฅุตูุงุญ |
|--------|-------------|-------------|
| **ุงููุงุชูุฑุฉ** | โ ูุง ูุชู ุฅูุดุงุคูุง | โ ุชููุดุฃ ุชููุงุฆูุงู |
| **ุงูููุฏ ุงููุญุงุณุจู** | โ ูููุดุฃ ูููุตูุงู | โ ูุฑุชุจุท ุจุงููุงุชูุฑุฉ |
| **ุจูุงูุงุช ุงูุนููู** | โ ูุงูุตุฉ | โ ูุงููุฉ (ุงุณูุ ุจุฑูุฏุ ูุงุชู) |
| **ุญุงูุฉ ุงููุงุชูุฑุฉ** | - | โ ISSUED โ PAID |
| **ุณุฌู ุงูุฏูุน** | โ ูุง ููุฌุฏ | โ AccInvoicePayment |
| **ูุนูููุงุช ูุฑุฌุนุฉ** | โ ููุท transactionId | โ invoiceId + journalEntryId |
| **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** | โ๏ธ ุบูุฑ ูุงุถุญุฉ | โ ูุญุณููุฉ ูุน ุชุณุฌูู |

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅูุฌุงุฒู:

1. โ **ุฅุตูุงุญ ุฌุฐุฑู ูููุธุงู ุงููุญุงุณุจู**
   - ุฅูุดุงุก ููุงุชูุฑ ุชููุงุฆูุงู ููู ุนูููุฉ ุฏูุน
   - ุฑุจุท ุงููููุฏ ุจุงูููุงุชูุฑ ุจุดูู ุตุญูุญ
   - ุณุฌู ุฏูุนุงุช ููุซู

2. โ **ุชุญุณูู ุฌูุฏุฉ ุงูุจูุงูุงุช**
   - ุจูุงูุงุช ุนููู ูุงููุฉ ูู ุงูููุงุชูุฑ
   - ูุนูููุงุช ูุฑุฌุนุฉ ุดุงููุฉ
   - ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณููุฉ

3. โ **ุงูุงูุชุซุงู ูููุนุงููุฑ**
   - ุชูุงูู ูุน ุงููุนุงููุฑ ุงููุญุงุณุจูุฉ ุงูุฏูููุฉ
   - ููุงุชูุฑ ุฑุณููุฉ ูุฌููุน ุงูุนูููุงุช
   - ูููุฏ ูุญุงุณุจูุฉ ููุธูุฉ

### ุงูุชุฃุซูุฑ ุนูู ุงูุนูููุงุช:

- **ุดุญู ุงููุญูุธุฉ:** โ ูุง ุชุบููุฑ (ูุงู ูุนูู)
- **ุฏูุน ุงุดุชุฑุงู:** โ **ุงูุขู ููุดุฆ ูุงุชูุฑุฉ + ููุฏ**
- **ุชุนููู ุจุงูุฉ:** โ ูุง ุชุบููุฑ (ูุงู ูุนูู)
- **ุงูุชุฌุฏูุฏ/ุงูุชุฑููุฉ:** โ **ุงูุขู ููุดุฆ ูุงุชูุฑุฉ + ููุฏ**

### ุงููููุงุช ุงููุนุฏูุฉ:

1. `apps/api/src/modules/wallet/wallet-accounting.bridge.ts`
   - ุฅุนุงุฏุฉ ููููุฉ `recordWalletPayment`
   - ุฅุถุงูุฉ ุฅูุดุงุก ููุงุชูุฑ
   - ุฅุฑุฌุงุน ูุนูููุงุช ูุงููุฉ

2. `apps/api/src/modules/wallet/wallet.service.ts`
   - ุฅุถุงูุฉ ุจูุงูุงุช ุงูุนููู
   - ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
   - ุฅุฑุฌุงุน ูุนูููุงุช ุงููุญุงุณุจุฉ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ุงุฎุชุจุงุฑ ูุทููุจ:

1. **ุงุฎุชุจุงุฑ ุชุฌุฏูุฏ ุจุงูุฉ:**
   ```bash
   POST /api/v1/wallet/pay
   {
     "businessId": "xxx",
     "packageId": "yyy"
   }
   ```
   - ุชุญูู ูู ุฅูุดุงุก ูุงุชูุฑุฉ
   - ุชุญูู ูู ุงูููุฏ ุงููุญุงุณุจู
   - ุชุญูู ูู ุงูุชุฏุงุฏ ุงูุจุงูุฉ ุจุดูู ุตุญูุญ

2. **ุงุฎุชุจุงุฑ ุชุฑููุฉ ุจุงูุฉ:**
   - ููุณ ุงูุฎุทูุงุช ุฃุนูุงู
   - ุชุญูู ูู ุญุณุงุจ ุฎุตู ุงูุฃูุงู ุงููุชุจููุฉ

3. **ูุฑุงุฌุนุฉ ุงูููุงุชูุฑ:**
   ```bash
   GET /api/v1/accounting/invoices
   ```

### ุชุทููุฑุงุช ูุณุชูุจููุฉ:

- [ ] ุฅุถุงูุฉ ุทุจุงุนุฉ PDF ููููุงุชูุฑ
- [ ] ุฅุฑุณุงู ุงูููุงุชูุฑ ุจุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- [ ] ููุญุฉ ุชุญูู ููููุงุชูุฑ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
- [ ] ุชูุงุฑูุฑ ูุญุงุณุจูุฉ ูุชูุฏูุฉ

---

**ุงูุญุงูุฉ ุงูููุงุฆูุฉ:** โ ุงููุธุงู ุงููุญุงุณุจู ูุชูุงูู ููุนูู ุจุดูู ุตุญูุญ  
**ุงูุชุงุฑูุฎ:** 7 ููุงูุฑ 2026  
**ุงูุฅุตุฏุงุฑ:** 8.0

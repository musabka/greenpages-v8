# ูุธุงู ุงูุจุงูุงุช (Subscription Packages)

ุชู ุชูููุฐ ูุธุงู ุงูุจุงูุงุช ูุฌุฒุก ุฃุณุงุณู ูู ููุงุฉ ุงููุธุงู ูุถูุงู ุชุญุฌูู ุงูููุฒุงุช ูุงููููุฏ ููู ูุดุงุท ุชุฌุงุฑู ุจุดูู ูุฑูุฒู.

## ุงูููููุงุช ุงูุฑุฆูุณูุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช (Prisma)
- **Package**: ุชุนุฑูู ุงูุจุงูุฉ (ุงูุงุณูุ ุงูุณุนุฑุ ุงููุฏุฉุ `isDefault`).
- **PackageFeature**: ุงูููุฒุงุช ุงูููุนูุฉ (ูุนู/ูุง) ูุซู "ุดุงุฑุฉ ุงูุชุญูู". ูุณุชุฎุฏู `FeatureKey` ูู ENUM.
- **PackageLimit**: ุงููููุฏ ุงููููุฉ ูุซู "ุงูุญุฏ ุงูุฃูุตู ูููุฑูุน". ูุณุชุฎุฏู `LimitKey` ูู ENUM.
- **BusinessPackage**: ุงูุฑุจุท ุจูู ุงููุดุงุท ูุงูุจุงูุฉ ูุญุงูุฉ ุงูุงุดุชุฑุงู + ุญููู Admin Override.
- **PackageHistory**: ุณุฌู ุงูุชุบููุฑุงุช ูุงูุชุฑููุงุช.

### 2. ุงููุญุฑู ุงููุฑูุฒู (PackagesService)
ูููุฑ ุฏุงูุงุช ููุชุญูู ูู ุงูุตูุงุญูุงุช ูุงููููุฏ:
- `canBusinessUseFeature(businessId, featureKey)`
- `getBusinessLimit(businessId, limitKey)`
- `getDefaultPackage()` - ุงูุญุตูู ุนูู ุงูุจุงูุฉ ุงูุงูุชุฑุงุถูุฉ
- `setDefaultPackage(packageId)` - ุชุนููู ุจุงูุฉ ูุงูุชุฑุงุถูุฉ

### 3. ุทุจูุฉ ุงูุญูุงูุฉ (PackageGuard)
ูููู ุงุณุชุฎุฏุงู `PackageGuard` ุนูู ุงูู Controllers ูุญูุงูุฉ ุงููุณุงุฑุงุช ุจูุงุกู ุนูู ุงูุจุงูุฉ:
```typescript
@CheckFeature(FeatureKey.AD_ALLOWED)
@UseGuards(JwtAuthGuard, PackageGuard)
@Post()
createAd(...) { ... }
```

---

## ุณููู ุงููุธุงู ุนูุฏ ุงูุชูุงุก ุงูุจุงูุฉ

### ๐ ุงูุจุงูุฉ ุงูุงูุชุฑุงุถูุฉ (Default Package)
ุนูุฏ ุงูุชูุงุก ุงุดุชุฑุงู ุงููุดุงุท ุงูุชุฌุงุฑูุ ูุชู **ุชููุงุฆูุงู** ุงูุฑุฌูุน ููุจุงูุฉ ุงูุงูุชุฑุงุถูุฉ ุจุฏูุงู ูู ุญุฑูุงู ุงููุดุงุท ูู ูู ุงูููุฒุงุช.

**ููููุฉ ุชุนููู ุงูุจุงูุฉ ุงูุงูุชุฑุงุถูุฉ:**
```typescript
// ูู ุฎูุงู ุงูู API ุฃู ุงูู Service
await packagesService.setDefaultPackage(packageId);
```

**ุงูุณููู:**
1. ุนูุฏ ุงูุชูุงุก `endDate` ููุจุงูุฉ ุงููุฏููุนุฉ:
   - ูุชู ุชุนููู ุงูุจุงูุฉ ูู `isActive: false`
   - ูุชู ุฅุฑุฌุงุน ุงูุจุงูุฉ ุงูุงูุชุฑุงุถูุฉ ุชููุงุฆูุงู
2. ุงูุจุงูุฉ ุงูุงูุชุฑุงุถูุฉ ุนุงุฏุฉู ุชููู ูุฌุงููุฉ ุจููุฒุงุช ูุญุฏูุฏุฉ
3. ูููู ูููุดุงุท ุงูุชุฑููุฉ ูู ุฃู ููุช

---

## ุชุญุณูู ุงูุฃุฏุงุก (Caching)

### ๐ Redis Caching
ูุชุฌูุจ ุงูุงุณุชุนูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูู ุทูุจุ ูุชู ุงุณุชุฎุฏุงู Redis ููุชุฎุฒูู ุงููุคูุช:

| Cache Key | ุงููุตู | TTL |
|-----------|-------|-----|
| `package:default` | ุงูุจุงูุฉ ุงูุงูุชุฑุงุถูุฉ | 5 ุฏูุงุฆู |
| `business:package:{businessId}` | ุจุงูุฉ ุงููุดุงุท ุงูุชุฌุงุฑู | 5 ุฏูุงุฆู |

**ุฅุจุทุงู ุงูู Cache:**
- ูุชู ุชููุงุฆูุงู ุนูุฏ ุชุนููู ุจุงูุฉ ุฌุฏูุฏุฉ
- ูุชู ุชููุงุฆูุงู ุนูุฏ ุชูุนูู/ุชุนุทูู Admin Override
- ูููู ูุฏููุงู: `await packagesService.invalidateBusinessPackageCache(businessId)`

---

## ุงูุชุฌุงูุฒ ุงูุฅุฏุงุฑู (Admin Override)

### โ๏ธ ูุชู ููุณุชุฎุฏูุ
ูู ุญุงูุงุช ุงุณุชุซูุงุฆูุฉ ููุทุ ูุซู:
- ููุญ ูุชุฑุฉ ุชุฌุฑูุจูุฉ ูุคูุชุฉ
- ุญู ูุดููุฉ ูููุฉ ููุนููู
- ุนุฑูุถ ุชุฑููุฌูุฉ ุฎุงุตุฉ

### ุงูุญููู ุงููุชุงุญุฉ:
| ุงูุญูู | ุงููุตู |
|-------|-------|
| `overrideEnabled` | ูู ุงูุชุฌุงูุฒ ููุนูุ |
| `overrideReason` | ุณุจุจ ุงูุชุฌุงูุฒ (ุฅูุฒุงูู) |
| `overrideExpiresAt` | ุชุงุฑูุฎ ุงูุชูุงุก ุงูุชุฌุงูุฒ (ุงุฎุชูุงุฑู) |
| `overrideByUserId` | ูุนุฑู ุงููุฏูุฑ ุงูุฐู ูุงู ุจุงูุชุฌุงูุฒ |

### ููููุฉ ุงูุงุณุชุฎุฏุงู:
```typescript
// ุชูุนูู ุงูุชุฌุงูุฒ
await packagesService.enableAdminOverride(
  businessId,
  adminUserId,
  'ูุชุฑุฉ ุชุฌุฑูุจูุฉ ููุฏุฉ ุฃุณุจูุน',
  new Date('2025-01-07'), // ุชุงุฑูุฎ ุงูุงูุชูุงุก
  request.ip,
  request.headers['user-agent'],
);

// ุชุนุทูู ุงูุชุฌุงูุฒ
await packagesService.disableAdminOverride(businessId, adminUserId);
```

### ๐ ุงูุชูุซูู ูุงูุชุณุฌูู:
**ูู ุชุฌุงูุฒ ุฅุฏุงุฑู ูุชู ุชุณุฌููู ูู `ActivityLog`** ูุน:
- ูุนุฑู ุงููุฏูุฑ ุงูุฐู ูุงู ุจุงูุชุฌุงูุฒ
- ุงูุณุจุจ
- ุชุงุฑูุฎ ุงูุงูุชูุงุก
- ุงูุจูุงูุงุช ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
- ุนููุงู IP ู User Agent

---

## ุงููููุฏ ูุงูููุฒุงุช ุงููุฏุนููุฉ

### ุงูููุฒุงุช (Features) - ENUM: `FeatureKey`
| ุงูููุชุงุญ | ุงููุตู |
|---------|-------|
| `AD_ALLOWED` | ุงูุณูุงุญ ุจุฅุถุงูุฉ ุฅุนูุงูุงุช |
| `VERIFIED_BADGE` | ุงูุญุตูู ุนูู ุดุงุฑุฉ ุงูุชุญูู |
| `FEATURED_LISTING` | ุธููุฑ ุงููุดุงุท ูู ุฃุนูู ูุชุงุฆุฌ ุงูุจุญุซ |
| `CUSTOM_LINKS` | ุงูุณูุงุญ ุจุฑูุงุจุท ุงูุชูุงุตู ุงููุฎุตุตุฉ |
| `PRIORITY_SUPPORT` | ุฏุนู ููู ุฐู ุฃููููุฉ |
| `ANALYTICS_DASHBOARD` | ุฅุญุตุงุฆูุงุช ูุชูุฏูุฉ |
| `UNLIMITED_PHOTOS` | ุตูุฑ ุบูุฑ ูุญุฏูุฏุฉ |

### ุงููููุฏ (Limits) - ENUM: `LimitKey`
| ุงูููุชุงุญ | ุงููุตู |
|---------|-------|
| `MAX_BRANCHES` | ุนุฏุฏ ุงููุฑูุน ุงููุณููุญ ุจูุง |
| `MAX_PERSONS` | ุนุฏุฏ ุงูููุธููู/ุงูุฃุดุฎุงุต ุงููุฑุชุจุทูู |
| `MAX_ADS` | ุนุฏุฏ ุงูุฅุนูุงูุงุช ุงููุดุทุฉ ูู ููุณ ุงูููุช |
| `MAX_GALLERY_PHOTOS` | ุนุฏุฏ ุงูุตูุฑ ูู ูุนุฑุถ ุงูุตูุฑ |
| `MAX_PRODUCTS` | ุนุฏุฏ ุงูููุชุฌุงุช ุฃู ุงูุฎุฏูุงุช ุงููุนุฑูุถุฉ |

---

## ุงูุชูุงูู ูุน ุงููุธุงู

1. **ุงูุฃูุดุทุฉ ุงูุชุฌุงุฑูุฉ (Businesses)**: ูุชู ุงูุชุญูู ูู ุงููููุฏ ุนูุฏ ุงูุชุญุฏูุซ (Branches, Persons, Products, Photos).
2. **ุงูุฅุนูุงูุงุช (Ads)**: ูุชู ุงูุชุญูู ูู ุณูุงุญูุฉ ุงูุฅุนูุงูุงุช ูุงูุญุฏ ุงูุฃูุตู ููุฅุนูุงูุงุช ุงููุดุทุฉ ุนูุฏ ุงูุฅูุดุงุก.
3. **ุงูุชุฑุชูุจ (Ranking)**: ุชุธูุฑ ุงูุฃูุดุทุฉ ุฐุงุช ุงูุจุงูุงุช ุงูุฃุนูู (ุจูุงุกู ุนูู `sortOrder` ุงูุฎุงุต ุจุงูุจุงูุฉ) ูู ุฃุนูู ูุชุงุฆุฌ ุงูุจุญุซ ุชููุงุฆูุงู.

---

## ููููุฉ ุงูุงุณุชุฎุฏุงู (Admin API)

### ุฅุฏุงุฑุฉ ุงูุจุงูุงุช
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| `GET` | `/api/v1/packages` | ูุงุฆูุฉ ุฌููุน ุงูุจุงูุงุช |
| `POST` | `/api/v1/packages` | ุฅูุดุงุก ุจุงูุฉ ุฌุฏูุฏุฉ |
| `PUT` | `/api/v1/packages/:id` | ุชุญุฏูุซ ุจุงูุฉ |
| `DELETE` | `/api/v1/packages/:id` | ุญุฐู ุจุงูุฉ (ุฅุฐุง ูู ููู ููุง ูุดุชุฑููู) |
| `POST` | `/api/v1/packages/:id/set-default` | ุชุนููู ูุจุงูุฉ ุงูุชุฑุงุถูุฉ |

### ุฅุฏุงุฑุฉ ุงุดุชุฑุงูุงุช ุงูุฃูุดุทุฉ
| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| `POST` | `/api/v1/packages/assign` | ุชุนููู ุจุงูุฉ ููุดุงุท ุชุฌุงุฑู |
| `GET` | `/api/v1/packages/business/:businessId` | ุฌูุจ ุจุงูุฉ ุงููุดุงุท ุงูุญุงููุฉ |
| `POST` | `/api/v1/packages/business/:businessId/override` | ุชูุนูู ุชุฌุงูุฒ ุฅุฏุงุฑู |
| `DELETE` | `/api/v1/packages/business/:businessId/override` | ุชุนุทูู ุงูุชุฌุงูุฒ ุงูุฅุฏุงุฑู |

---

## ูุซุงู ุนูู ุฅูุดุงุก ุจุงูุฉ

```json
POST /api/v1/packages
{
  "nameAr": "ุงูุจุงูุฉ ุงูุฐูุจูุฉ",
  "nameEn": "Gold Package",
  "slug": "gold",
  "price": 50000,
  "durationDays": 365,
  "isDefault": false,
  "sortOrder": 2,
  "features": [
    { "featureKey": "AD_ALLOWED", "isEnabled": true },
    { "featureKey": "VERIFIED_BADGE", "isEnabled": true },
    { "featureKey": "FEATURED_LISTING", "isEnabled": true }
  ],
  "limits": [
    { "limitKey": "MAX_BRANCHES", "limitValue": 10 },
    { "limitKey": "MAX_PERSONS", "limitValue": 20 },
    { "limitKey": "MAX_ADS", "limitValue": 5 },
    { "limitKey": "MAX_GALLERY_PHOTOS", "limitValue": 50 },
    { "limitKey": "MAX_PRODUCTS", "limitValue": 100 }
  ]
}
```

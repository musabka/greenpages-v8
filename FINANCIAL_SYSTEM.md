# النظام المالي - دليل شامل

## نظرة عامة

النظام المالي تم تصميمه لإدارة المقبوضات والمدفوعات بين المندوبين ومدراء المحافظات والشركة. يعتمد النظام على مفهوم **الذمم المالية** التي يتم تفريغها عند كل تسديد.

---

## آلية العمل

### 1. المندوب (Agent)

#### المسؤوليات:
- زيارة الشركات ميدانياً
- قبض الاشتراكات نقداً
- تسليم الأموال للمحاسب في مقر الشركة

#### الذمة المالية:
- **تسجل** عند قبض أي مبلغ من شركة
- **تُفرّغ** عند تسليم المبلغ للمحاسب

#### الراتب والعمولات:
- راتب ثابت (يحدده مدير المحافظة)
- نسبة مئوية من كل اشتراك (يحددها مدير المحافظة)

#### الصفحات المتاحة:
- `/dashboard/financial` - لوحة التحكم الرئيسية
- `/dashboard/financial/collections` - سجل جميع المقبوضات
- `/dashboard/financial/submit-payment` - تسجيل تسليم مبلغ للمحاسب

---

### 2. مدير المحافظة (Manager)

#### المسؤوليات:
- إدارة المندوبين في محافظته
- تحديد رواتب ونسب عمولات المندوبين
- تسليم نسبة من الدخل الإجمالي للشركة

#### الذمة المالية:
- **تسجل** من مجموع مقبوضات جميع المندوبين التابعين له
- **تُفرّغ** عند تسليم المبلغ للشركة الأم

#### النسبة المئوية:
- الشركة تأخذ نسبة مئوية من إجمالي المقبوضات
- هذه النسبة يحددها الإدارة (Admin) لكل مدير على حدة

#### الصفحات المتاحة:
- `/dashboard/financial` - لوحة التحكم المالية
- `/dashboard/financial/agents` - إدارة رواتب ونسب المندوبين

---

### 3. الإدارة (Admin)

#### المسؤوليات:
- تحديد نسبة العمولة لكل مدير محافظة
- استلام الأموال من مدراء المحافظات
- مراقبة النظام المالي بالكامل

#### الصفحات المتاحة:
- `/financial` - نظرة عامة على النظام المالي
- `/financial/managers` - إدارة مدراء المحافظات (تحديد النسب واستلام الأموال)
- `/financial/transactions` - سجل جميع المعاملات المالية
- `/financial/reports` - التقارير والإحصائيات المالية

---

## قاعدة البيانات

### الجداول الرئيسية:

#### 1. `agent_collections`
تسجيل كل مبلغ يقبضه المندوب من شركة:
- `id` - معرف فريد
- `agentId` - معرف المندوب
- `businessId` - معرف النشاط التجاري
- `packageId` - معرف الباقة المباعة
- `amount` - المبلغ المقبوض
- `collectedAt` - تاريخ القبض
- `status` - الحالة: `COLLECTED` (معلق) أو `SUBMITTED` (مُسلّم)
- `settlementId` - معرف عملية التسوية (إن وجدت)

#### 2. `agent_settlements`
تسجيل كل عملية تسليم مندوب للأموال:
- `id` - معرف فريد
- `agentId` - معرف المندوب
- `amount` - المبلغ المُسلّم
- `accountantId` - معرف المحاسب المستلم
- `requestedAt` - تاريخ الطلب
- `approvedAt` - تاريخ الموافقة
- `status` - الحالة: `PENDING`, `APPROVED`, `REJECTED`

#### 3. `manager_commission_settings`
إعدادات عمولة مدير المحافظة:
- `id` - معرف فريد
- `managerId` - معرف مدير المحافظة
- `rate` - النسبة المئوية للشركة
- `notes` - ملاحظات
- `setBy` - من قام بالتعيين
- `effectiveFrom` - تاريخ سريان النسبة

#### 4. `manager_balance_ledger`
سجل الذمم المالية لمدير المحافظة:
- `id` - معرف فريد
- `managerId` - معرف مدير المحافظة
- `amount` - المبلغ (موجب = مدين، سالب = دائن)
- `type` - نوع العملية:
  - `AGENT_COLLECTION` - مقبوضات من مندوب
  - `PAYMENT_TO_COMPANY` - دفع للشركة
  - `ADJUSTMENT` - تعديل
- `relatedCollectionId` - معرف المقبوض المرتبط
- `relatedSettlementId` - معرف التسوية المرتبطة
- `notes` - ملاحظات

---

## API Endpoints

### For Agents:

```
GET    /api/v1/financial/agent/balance           # الرصيد الحالي
GET    /api/v1/financial/agent/collections       # سجل المقبوضات
GET    /api/v1/financial/agent/commissions       # سجل العمولات
POST   /api/v1/financial/agent/collect           # تسجيل مقبوض جديد
POST   /api/v1/financial/agent/submit-payment    # تسليم مبلغ للمحاسب
```

### For Managers:

```
GET    /api/v1/financial/manager/balance            # الرصيد الحالي
GET    /api/v1/financial/manager/agents             # قائمة المندوبين مع أرصدتهم
GET    /api/v1/financial/manager/commission-rate    # نسبة العمولة الحالية
PUT    /api/v1/financial/manager/agents/:agentId   # تحديث راتب ونسبة المندوب
```

### For Admin:

```
GET    /api/v1/financial/admin/overview                         # نظرة عامة
GET    /api/v1/financial/admin/managers                         # قائمة المدراء مع أرصدتهم
PUT    /api/v1/financial/admin/managers/:managerId/commission   # تحديث نسبة مدير
POST   /api/v1/financial/admin/receive-payment                  # استلام مبلغ من مدير
```

---

## سير العمل (Workflow)

### سيناريو كامل:

1. **المندوب** يزور شركة ويقبض اشتراك بقيمة 1,000,000 ل.س
   - يتم تسجيل `agent_collection` بحالة `COLLECTED`
   - يتم حساب عمولة المندوب (مثلاً 10% = 100,000 ل.س)
   - رصيد المندوب الآن: 1,000,000 ل.س

2. **المندوب** يسلم المبلغ للمحاسب
   - يتم إنشاء `agent_settlement` بمبلغ 1,000,000 ل.س
   - يتم تحديث حالة المقبوض إلى `SUBMITTED`
   - رصيد المندوب يصبح: 0 ل.س
   - يتم تسجيل الذمة في `manager_balance_ledger` لمدير المحافظة

3. **مدير المحافظة** لديه الآن 1,000,000 ل.س في ذمته
   - إذا كانت نسبة الشركة 15%، يجب أن يسلم 150,000 ل.س
   - يبقى لديه 850,000 ل.س صافي

4. **الإدارة** تستلم من مدير المحافظة
   - عند استلام 150,000 ل.س، يتم تسجيل عملية دفع
   - يتم تفريغ الذمة المالية للمدير

---

## التقارير والإحصائيات

### المندوب يرى:
- رصيده الحالي
- إجمالي المقبوضات
- إجمالي المُسلّم
- إجمالي العمولات المستحقة

### مدير المحافظة يرى:
- رصيده المستحق للشركة
- إجمالي مقبوضات مندوبيه
- إجمالي ما سلّمه للشركة
- أداء كل مندوب

### الإدارة ترى:
- إجمالي الإيرادات
- الذمم المستحقة من جميع المدراء
- عدد المدراء والمندوبين
- إجمالي النشاطات التجارية

---

## الأمان والصلاحيات

- **المندوب**: يرى فقط معاملاته الخاصة
- **مدير المحافظة**: يرى معاملات مندوبيه فقط
- **الإدارة**: ترى جميع المعاملات

جميع Endpoints محمية بـ JWT Authentication و Role-Based Guards.

---

## الميزات الإضافية

### 1. إشعارات تلقائية
- تنبيه المندوب عند تجاوز رصيده حد معين
- تنبيه مدير المحافظة بذمته المستحقة
- تنبيه الإدارة بالمدراء المتأخرين في الدفع

### 2. التدقيق (Audit Trail)
- جميع العمليات مسجلة مع التاريخ والمستخدم
- إمكانية تتبع أي معاملة مالية

### 3. المرونة
- إمكانية تعديل نسب العمولات في أي وقت
- النسب الجديدة تسري من تاريخ التعديل فصاعداً

---

## كيفية الاستخدام

### للمندوب:
1. انتقل إلى `/dashboard/financial`
2. عند قبض مبلغ، سيظهر في الرصيد الحالي
3. عند جمع مبالغ كافية، اذهب إلى "تسليم مبلغ للمحاسب"
4. حدد المبلغ والمحاسب المستلم
5. بعد الموافقة، سيتم تفريغ رصيدك

### لمدير المحافظة:
1. انتقل إلى `/dashboard/financial/agents`
2. عدّل رواتب ونسب عمولات المندوبين
3. راقب رصيدك المستحق للشركة
4. سلّم المبالغ المستحقة للإدارة

### للإدارة:
1. انتقل إلى `/financial/managers`
2. حدد نسبة العمولة لكل مدير محافظة
3. عند استلام مبلغ من مدير، اضغط على أيقونة "$"
4. أدخل المبلغ المستلم
5. سيتم تفريغ الذمة المالية تلقائياً

---

## الدعم الفني

للأسئلة أو المشاكل، يرجى التواصل مع فريق التطوير.

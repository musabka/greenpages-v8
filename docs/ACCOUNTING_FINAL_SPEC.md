# ๐ ุงูููุงุตูุงุช ุงูููุงุฆูุฉ ูููุธุงู ุงููุญุงุณุจู
# ACCOUNTING_FINAL_SPEC.md

**ุงูุฅุตุฏุงุฑ:** 2.0  
**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** ููุงูุฑ 2026  
**ุงูุญุงูุฉ:** Production-Ready  
**ุงูุงุณุชูุฑุงุฑ:** 3+ ุณููุงุช

---

## 1. ูุธุฑุฉ ุนุงูุฉ

ุงููุธุงู ุงููุญุงุณุจู ูู GreenPages ูู **ุงููุตุฏุฑ ุงููุญูุฏ ููุญูููุฉ ุงููุงููุฉ (SSOT)** ููู ุงูุนูููุงุช ุงููุงููุฉ ูู ุงูููุตุฉ.

### 1.1 ุงููุจุงุฏุฆ ุงูุฃุณุงุณูุฉ

| ุงููุจุฏุฃ | ุงููุตู |
|--------|------|
| **Double-Entry** | ูู ููุฏ ูุฌุจ ุฃู ูููู ูุชูุงุฒูุงู (ูุฌููุน ุงููุฏูู = ูุฌููุน ุงูุฏุงุฆู) |
| **Immutability** | ุงููููุฏ ุงููุฑุญููุฉ (POSTED) ูุง ุชูุญุฐู ุฃู ุชูุนุฏูู ุฃุจุฏุงู |
| **Auditability** | ูู ุชุบููุฑ ูุณุฌูู ูู AccAuditLog |
| **Idempotency** | sourceEventId ูุฑูุฏ ูููุน ุงูุชูุฑุงุฑ |
| **Period Enforcement** | ุงููุชุฑุงุช ุงููุบููุฉ (CLOSED) ูุง ุชูุจู ูููุฏ ุฌุฏูุฏุฉ |

### 1.2 ุงูุนูุงูุฉ ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ACCOUNTING (SSOT)                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  AccJournalEntry + AccJournalLine                       โโ
โ  โ  - ุงูุญูููุฉ ุงููุงููุฉ                                      โโ
โ  โ  - ูุง ููุนุฏูู ุจุนุฏ POST                                    โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ                    โ                    โ
          โ                    โ                    โ
    โโโโโโโดโโโโโโ        โโโโโโโดโโโโโโ        โโโโโโโดโโโโโโ
    โ  Wallet   โ        โ Commissionsโ        โ Invoicing โ
    โ(Projection)โ       โ(Projection)โ        โ  (Source) โ
    โโโโโโโโโโโโโ        โโโโโโโโโโโโโ        โโโโโโโโโโโโโ
```

---

## 2. ุงููููู ุงูุชููู

### 2.1 ุงูููุงุฐุฌ ุงูุฃุณุงุณูุฉ

#### AccJournalEntry (ุงูููุฏ ุงููุญุงุณุจู)
```prisma
model AccJournalEntry {
  id              String           @id @default(cuid())
  entryNumber     String           @unique
  occurredAt      DateTime         
  description     String
  descriptionAr   String?
  status          AccJournalStatus @default(DRAFT)
  postedAt        DateTime?
  sourceModule    AccSourceModule
  sourceEventId   String?          @unique  // ููู Idempotency
  sourceEntityType String?
  sourceEntityId   String?
  currencyId      String
  periodId        String
  createdById     String
  metadata        Json?
  lines           AccJournalLine[]
}
```

#### AccJournalLine (ุณุทุฑ ุงูููุฏ)
```prisma
model AccJournalLine {
  id            String   @id @default(cuid())
  journalEntryId String
  accountId     String
  debit         Decimal  @default(0)
  credit        Decimal  @default(0)
  memo          String?
  dimensions    Json?    @db.JsonB  // ููุชุญููู ุงููุงูู
}
```

### 2.2 ุงูุฃุจุนุงุฏ (Dimensions)

ุงูุฃุจุนุงุฏ ุงููุณููุญุฉ ููุชุญููู ุงููุงูู:

| Dimension | ุงููุตู | ูุซุงู |
|-----------|------|------|
| `governorateId` | ุงููุญุงูุธุฉ | `gov-damascus` |
| `cityId` | ุงููุฏููุฉ | `city-damascus` |
| `districtId` | ุงูููุทูุฉ | `district-mazzeh` |
| `userId` | ุงููุณุชุฎุฏู | `user-12345` |
| `businessId` | ุงููุดุงุท ุงูุชุฌุงุฑู | `business-789` |
| `agentProfileId` | ููู ุงูููุฏูุจ | `agent-456` |
| `sourceModule` | ุงูููุฏููู ุงููุตุฏุฑ | `WALLET` |
| `projectKey` | ููุชุงุญ ุงููุดุฑูุน | `greencore-v2` |

---

## 3. ุฏููู ุงูุญุณุงุจุงุช

### 3.1 ุงูุญุณุงุจุงุช ุงูุฑุฆูุณูุฉ

```
1000 - ุงูุฃุตูู (Assets)
โโโ 1100 - ุงูุฃุตูู ุงูููุฏูุฉ
โ   โโโ 1101 - ุงูุตูุฏูู (Cash)
โ   โโโ 1102 - ุงูุจูู ุงูุฑุฆูุณู (Bank Main)
โ   โโโ 1103 - ุจูุงุจุงุช ุงูุฏูุน (Payment Gateways)
โ   โโโ 1104 - ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ (Mobile Money)
โโโ 1200 - ุงูุฐูู ุงููุฏููุฉ
โ   โโโ 1201 - ุฐูู ุงูุนููุงุก (Customer Receivables)
โ
2000 - ุงูุงูุชุฒุงูุงุช (Liabilities)
โโโ 2100 - ุงูุงูุชุฒุงูุงุช ุงููุชุฏุงููุฉ
โ   โโโ 2101 - ุงูุชุฒุงู ุงููุญุงูุธ (Wallet Liability)
โโโ 2200 - ูุณุชุญูุงุช ุงูููุฏูุจูู
โ   โโโ 2201 - ูุณุชุญู ููููุฏูุจูู (Agent Payable)
โ   โโโ 2202 - ูุณุชุญู ูููุฏูุฑูู (Manager Payable)
โโโ 2300 - ุงูุถุฑุงุฆุจ ุงููุณุชุญูุฉ
โ   โโโ 2301 - ุถุฑุงุฆุจ ุงูููุตุฉ (Platform Tax Payable)
โ   โโโ 2302 - ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (VAT Payable)
โ   โโโ 2303 - ุถุฑุงุฆุจ ุงููุญุงูุธุงุช (Governorate Tax Payable)
โ
3000 - ุญููู ุงูููููุฉ (Equity)
โโโ 3100 - ุฑุฃุณ ุงููุงู (Capital)
โโโ 3200 - ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ (Retained Earnings)
โ
4000 - ุงูุฅูุฑุงุฏุงุช (Revenue)
โโโ 4100 - ุฅูุฑุงุฏุงุช ุงูุงุดุชุฑุงูุงุช (Subscription Revenue)
โโโ 4200 - ุฅูุฑุงุฏุงุช ุงูุฅุนูุงูุงุช (Ads Revenue)
โโโ 4300 - ุฅูุฑุงุฏุงุช ุงูุฎุฏูุงุช (Service Revenue)
โโโ 4400 - ุฅูุฑุงุฏุงุช ุฑุณูู ุงูุดุญู (Top-up Fee Revenue)
โโโ 4500 - ุฅูุฑุงุฏุงุช ุงููุญุงูุธุงุช (Governorate Revenue)
โโโ 4199 - ุชุนุฏูู ุงูุฅูุฑุงุฏุงุช (Revenue Adjustment) - ูููุฑุชุฌุนุงุช
โ
5000 - ุงููุตุฑููุงุช (Expenses)
โโโ 5100 - ูุตุฑููุงุช ุงูุนูููุงุช (Commission Expense)
โโโ 5200 - ุฑุณูู ุจูุงุจุงุช ุงูุฏูุน (Payment Fees Expense)
โโโ 5300 - ูุตุฑููุงุช ุชุดุบูููุฉ (Operating Expense)
โโโ 5400 - ููุงูุขุช ุงูุชูุนูุจ (Gamification Expense)
```

---

## 4. ุณููุงุฑูููุงุช ุงููููุฏ

### 4.1 ุดุญู ุงููุญูุธุฉ (Wallet Top-Up)

```
ุงูุญุฏุซ: ุงููุณุชุฎุฏู ูุดุญู ูุญูุธุชู ุจู 10,000 ู.ุณ ุนุจุฑ ุงูููุฏ

ุงูููุฏ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุญู/ ุงูุตูุฏูู (1101)                    10,000    ูุฏูู       โ
โ       ุญู/ ุงูุชุฒุงู ุงููุญุงูุธ (2101)              10,000 ุฏุงุฆู   โ
โ ุงููุตู: ุดุญู ูุญูุธุฉ ุนุจุฑ ุงูููุฏ                                  โ
โ ุงููุตุฏุฑ: WALLET / TOPUP-APPROVED-{topUpId}                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Dimensions:
- userId: {walletOwnerId}
- governorateId: {governorateId}
- agentProfileId: {agentProfileId} // ุฅู ุชู ุนุจุฑ ููุฏูุจ
```

### 4.2 ุงูุฏูุน ูู ุงููุญูุธุฉ (ุงุดุชุฑุงู)

```
ุงูุญุฏุซ: ุฏูุน ุงุดุชุฑุงู 12,000 ู.ุณ (ูููุง 2,000 ุถุฑูุจุฉ)

ุงูููุฏ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุญู/ ุงูุชุฒุงู ุงููุญุงูุธ (2101)            12,000    ูุฏูู       โ
โ       ุญู/ ุฅูุฑุงุฏุงุช ุงูุงุดุชุฑุงูุงุช (4100)          10,000 ุฏุงุฆู   โ
โ       ุญู/ ุถุฑุงุฆุจ ุงูููุตุฉ (2301)                2,000 ุฏุงุฆู   โ
โ ุงููุตู: ุฏูุน ุงุดุชุฑุงู ูู ุงููุญูุธุฉ                                โ
โ ุงููุตุฏุฑ: WALLET / PAYMENT-{paymentId}                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 4.3 ุงุณุชุญูุงู ุนูููุฉ ููุฏูุจ

```
ุงูุญุฏุซ: ููุฏูุจ ูุณุชุญู 1,500 ู.ุณ ุนูููุฉ

ุงูููุฏ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุญู/ ูุตุฑููุงุช ุงูุนูููุงุช (5100)          1,500    ูุฏูู       โ
โ       ุญู/ ูุณุชุญู ููููุฏูุจูู (2201)             1,500 ุฏุงุฆู   โ
โ ุงููุตู: ุนูููุฉ ููุฏูุจ ูุณุชุญูุฉ                                   โ
โ ุงููุตุฏุฑ: COMMISSIONS / COMMISSION-EARNED-{id}               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 4.4 ุชุณููุฉ ูุณุชุญูุงุช ููุฏูุจ

```
ุงูุญุฏุซ: ุฏูุน 5,000 ู.ุณ ููููุฏูุจ ููุฏุงู

ุงูููุฏ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุญู/ ูุณุชุญู ููููุฏูุจูู (2201)           5,000    ูุฏูู       โ
โ       ุญู/ ุงูุตูุฏูู (1101)                     5,000 ุฏุงุฆู   โ
โ ุงููุตู: ุฏูุน ูุณุชุญูุงุช ููุฏูุจ                                    โ
โ ุงููุตุฏุฑ: COMMISSIONS / SETTLEMENT-{id}                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 4.5 ุฅุตุฏุงุฑ ูุงุชูุฑุฉ

```
ุงูุญุฏุซ: ุฅุตุฏุงุฑ ูุงุชูุฑุฉ ุจูููุฉ 15,000 ู.ุณ

ุงูููุฏ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุญู/ ุฐูู ุงูุนููุงุก (1201)               15,000    ูุฏูู       โ
โ       ุญู/ ุฅูุฑุงุฏุงุช ุงูุงุดุชุฑุงูุงุช (4100)          15,000 ุฏุงุฆู   โ
โ ุงููุตู: ูุงุชูุฑุฉ INV-2026-000001                              โ
โ ุงููุตุฏุฑ: INVOICING / INVOICE-ISSUED-{id}                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุดุฑูุท:
- Invoice.status ูุชุญูู ุฅูู ISSUED
- Invoice.journalEntryId ููุฑุจุท ุจุงูููุฏ
- Invoice.issuedAt ููุณุฌู
```

### 4.6 ุฅุดุนุงุฑ ุฏุงุฆู (ุงุณุชุฑุฏุงุฏ)

```
ุงูุญุฏุซ: ุงุณุชุฑุฏุงุฏ ุฌุฒุฆู 3,000 ู.ุณ

ุงูููุฏ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุญู/ ุชุนุฏูู ุงูุฅูุฑุงุฏุงุช (4199)           3,000    ูุฏูู       โ
โ       ุญู/ ุฐูู ุงูุนููุงุก (1201)                 3,000 ุฏุงุฆู   โ
โ ุงููุตู: ุฅุดุนุงุฑ ุฏุงุฆู CN-2026-000001                           โ
โ ุงููุตุฏุฑ: INVOICING / CREDIT-NOTE-ISSUED-{id}                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 5. ูุงุฌูุงุช API

### 5.1 ุงูู Endpoints ุงูุฃุณุงุณูุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|------|
| GET | `/admin/accounting/health` | ูุญุต ุญุงูุฉ ุงูููุฏููู |
| GET | `/admin/accounting/stats` | ุฅุญุตุงุฆูุงุช ุงููุธุงู |
| GET | `/admin/accounting/accounts` | ุดุฌุฑุฉ ุงูุญุณุงุจุงุช |
| POST | `/admin/accounting/accounts/seed` | ุฅูุดุงุก ุงูุญุณุงุจุงุช ุงูุฃุณุงุณูุฉ |
| GET | `/admin/accounting/journal-entries` | ูุงุฆูุฉ ุงููููุฏ |
| POST | `/admin/accounting/journal-entries/manual` | ุฅูุดุงุก ููุฏ ูุฏูู |
| PATCH | `/admin/accounting/journal-entries/:id/post` | ุชุฑุญูู ููุฏ |
| PATCH | `/admin/accounting/journal-entries/:id/void` | ุฅูุบุงุก ููุฏ |
| GET | `/admin/accounting/reports/trial-balance` | ููุฒุงู ุงููุฑุงุฌุนุฉ |

### 5.2 ุงูููุชุฑุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|------|
| GET | `/admin/accounting/invoices` | ูุงุฆูุฉ ุงูููุงุชูุฑ |
| GET | `/admin/accounting/invoices/:id` | ุชูุงุตูู ูุงุชูุฑุฉ |
| PATCH | `/admin/accounting/invoices/:id/issue` | ุฅุตุฏุงุฑ ูุงุชูุฑุฉ |
| PATCH | `/admin/accounting/invoices/:id/cancel` | ุฅูุบุงุก ูุงุชูุฑุฉ |
| POST | `/admin/accounting/invoices/:id/payment` | ุชุณุฌูู ุฏูุน |
| POST | `/admin/accounting/invoices/:id/credit-note` | ุฅูุดุงุก ุฅุดุนุงุฑ ุฏุงุฆู |

### 5.3 ุงููุทุงุจูุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|------|
| GET | `/admin/accounting/reconcile/wallets` | ูุทุงุจูุฉ ุฌููุน ุงููุญุงูุธ |
| GET | `/admin/accounting/reconcile/wallets/:id` | ูุทุงุจูุฉ ูุญูุธุฉ ูุงุญุฏุฉ |
| PATCH | `/admin/accounting/reconcile/wallets/:id/fix` | ุชุตุญูุญ ุฑุตูุฏ ูุญูุธุฉ |
| GET | `/admin/accounting/reconcile/clearing-accounts` | ูุทุงุจูุฉ ุญุณุงุจุงุช ุงูููุงุตุฉ |
| GET | `/admin/accounting/reconcile/wallet-liability` | ุชูุฑูุฑ ุงูุชุฒุงูุงุช ุงููุญุงูุธ |

---

## 6. ุงูุฃูุงู ูุงูุตูุงุญูุงุช

### 6.1 ุงูุฃุฏูุงุฑ ุงููุทููุจุฉ

| ุงูุนูููุฉ | ุงูุฏูุฑ ุงููุทููุจ |
|---------|--------------|
| ุนุฑุถ ุงููููุฏ | `ADMIN`, `ACCOUNTANT` |
| ุฅูุดุงุก ููุฏ ูุฏูู | `ADMIN`, `ACCOUNTANT` |
| ุชุฑุญูู ููุฏ | `ADMIN`, `ACCOUNTANT` |
| ุฅูุบุงุก ููุฏ | `ADMIN` ููุท |
| ุฅุบูุงู ูุชุฑุฉ | `ADMIN` ููุท |
| ุฅุตุฏุงุฑ ูุงุชูุฑุฉ | `ADMIN`, `ACCOUNTANT` |
| ุงููุทุงุจูุฉ | `ADMIN`, `ACCOUNTANT` |
| ุชุตุญูุญ ุฃุฑุตุฏุฉ | `ADMIN` ููุท |

### 6.2 ูุทุงู ุงููุญุงูุธุงุช (Governorate Scope)

```
- ุงููุฏูุฑ ุงูุฅููููู ูุฑู ููุท ุจูุงูุงุช ูุญุงูุธุชู
- dimensions.governorateId ููุณุชุฎุฏู ููููุชุฑุฉ
- ADMIN ูุฑู ุฌููุน ุงููุญุงูุธุงุช
```

---

## 7. ุฃูุถู ุงูููุงุฑุณุงุช

### 7.1 ูููุทูุฑูู

1. **ูุง ุชููุดุฆ ูููุฏุงู ูุจุงุดุฑุฉ** - ุงุณุชุฎุฏู `AccountingPolicyService`
2. **ูุง ุชูุชุจ account codes ูู ุงูู services** - ุงุณุชุฎุฏู `ACCOUNT_CODES` constant
3. **ุฏุงุฆูุงู ุฃุฑุณู dimensions** - ููุชุญููู ุงููุงูู ูุงุญูุงู
4. **ุงุณุชุฎุฏู sourceEventId ูุฑูุฏ** - ูุถูุงู ุงูู Idempotency

### 7.2 ูููุญุงุณุจูู

1. **ุฑุงุฌุน ุงููููุฏ ุงููุนููุฉ ููููุงู** - `/journal-entries?status=DRAFT`
2. **ุฃุบูู ุงููุชุฑุงุช ูู ููุนุฏูุง** - ููุงูุฉ ูู ุดูุฑ
3. **ุชุงุจุน ุชูุงุฑูุฑ ุงููุทุงุจูุฉ** - `/reconcile/wallets`
4. **ูุง ุชุนุชูุฏ ุนูู Wallet.balance ูุญุฏู** - ุฑุงุฌุน Accounting

---

## 8. ุงููููุงุช ุงูุชูููุฉ

```
apps/api/src/modules/accounting/
โโโ accounting.module.ts           # ุชุณุฌูู ุงูููุฏููู
โโโ accounting.service.ts          # ุงูุฎุฏูุฉ ุงูุฑุฆูุณูุฉ (~1100 ุณุทุฑ)
โโโ accounting-policy.service.ts   # ุทุจูุฉ ุงูุณูุงุณุงุช (~680 ุณุทุฑ)
โโโ accounting-reconciliation.service.ts  # ุงููุทุงุจูุฉ (~280 ุณุทุฑ)
โโโ accounting-admin.controller.ts # ุงูู Controller (~300 ุณุทุฑ)
โโโ accounting.integration.spec.ts # ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู
โโโ dto/
    โโโ accounting.dto.ts          # ุงูู DTOs
```

---

## 9. ุงูุฏุนู ูุงูุตูุงูุฉ

### 9.1 ุงููุฑุงูุจุฉ

- **Health Check**: `GET /admin/accounting/health`
- **Daily Reconciliation**: ูููุฉ ูุฌุฏููุฉ ููููุงู
- **Alert on Discrepancy**: ุฅุดุนุงุฑ ุนูุฏ ุงูุชุดุงู ูุฑู > 100 ู.ุณ

### 9.2 ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

| ุงูุฎุทุฃ | ุงูุณุจุจ | ุงูุญู |
|------|------|-----|
| `ุงูููุฏ ุบูุฑ ูุชูุงุฒู` | ูุฌููุน ุงููุฏูู โ ูุฌููุน ุงูุฏุงุฆู | ุฑุงุฌุน ุงูุฃุฑูุงู |
| `ุงูุญุณุงุจ ุบูุฑ ููุฌูุฏ` | ููุฏ ุญุณุงุจ ุฎุงุทุฆ | ุชุฃูุฏ ูู ูุฌูุฏ ุงูุญุณุงุจ |
| `ูุง ูููู ุงูุชุฑุญูู ูู ูุชุฑุฉ ูุบููุฉ` | ุงููุชุฑุฉ ูุบููุฉ | ุงุณุชุฎุฏู ูุชุฑุฉ ููุชูุญุฉ |
| `sourceEventId ููุฑุฑ` | ุงูุนูููุฉ ูุณุฌูุฉ ูุณุจูุงู | ูุง ุญุงุฌุฉ ูุชูุฑุงุฑ |

---

**ุขุฎุฑ ุชุญุฏูุซ:** ููุงูุฑ 2026  
**ุงููุณุคูู:** ูุฑูู ุงูุชุทููุฑ - GreenPages
